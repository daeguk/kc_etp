<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="etpOper">

    <!--
    * ETP 운용관리 - PDF관리 정보를 조회한다.
    * 2019-05-03  bkLove(촤병국)
    -->
    <select id="getEtpOperPdf">
    <![CDATA[
        SELECT      /* etpOper.getEtpOperPdf  ETP 운용관리 - PDF관리 정보를 조회한다. */

                    base.date                                                   AS  date            /* Date */
                ,   base.market_gubun                                           AS  market_gubun    /* 시장구분 */
                ,   base.jongmok_code                                           AS  jongmok_code    /* 종목코드 */
                ,   base.jongmok_nm                                             AS  jongmok_nm      /* 종목명 */
                ,   base.cuShrs                                                 AS  cuShrs          /* CU SHrs */
                ,   base.org_money                                              AS  org_money       /* 액면금액 */
                ,   base.eval_monry                                             AS  eval_monry      /* 평가금액 */
                ,   base.rate                                                   AS  rate            /* 비중 */

          FROM  (
                    SELECT      '20181112'                                      AS  date            /* Date */
                            ,   '2'                                             AS  market_gubun    /* 시장구분 */
                            ,   'KRD0001112'                                    AS  jongmok_code    /* 종목코드 */
                            ,   '원화현금'                                       AS  jongmok_nm      /* 종목명 */
                            ,   771717171                                       AS  cuShrs          /* CU SHrs */
                            ,   11111                                           AS  org_money       /* 액면금액 */
                            ,   3434343434                                      AS  eval_monry      /* 평가금액 */
                            ,   85.64                                           AS  rate            /* 비중 */

                    FROM  dual

                    UNION   ALL

                    SELECT      '20181113'                                      AS  date            /* Date */
                            ,   '2'                                             AS  market_gubun    /* 시장구분 */
                            ,   'KRD0001333'                                    AS  jongmok_code    /* 종목코드 */
                            ,   '삼성전자'                                       AS  jongmok_nm      /* 종목명 */
                            ,   343444                                          AS  cuShrs          /* CU SHrs */
                            ,   77777                                           AS  org_money       /* 액면금액 */
                            ,   787878                                          AS  eval_monry      /* 평가금액 */
                            ,   11.22                                           AS  rate            /* 비중 */

                    FROM  dual

                    UNION   ALL

                    SELECT      '20181114'                                      AS  date            /* Date */
                            ,   '3'                                             AS  market_gubun    /* 시장구분 */
                            ,   'KRD0001444'                                    AS  jongmok_code    /* 종목코드 */
                            ,   '예금'                                          AS  jongmok_nm      /* 종목명 */
                            ,   89898989                                        AS  cuShrs          /* CU SHrs */
                            ,   44444                                           AS  org_money       /* 액면금액 */
                            ,   888888                                          AS  eval_monry      /* 평가금액 */
                            ,   10.44                                           AS  rate            /* 비중 */

                    FROM  dual                    

                )       base

         WHERE  1 = 1
    ]]>
    </select>

    <!--
    * EtpBasic 컬럼 SQL 정보를 추출한다.
    * 2019-04-25  bkLove(촤병국)
    -->
    <sql    id="sqlEtpBasic01">
    <![CDATA[
                    DATE_FORMAT( td_etp_basic.F12506, '%Y.%m.%d' )      AS  f12506              /* 입회일 */
                ,   td_etp_basic.F16012                                 AS  f16012              /* 국제표준코드 */
                ,   td_etp_basic.F16013                                 AS  f16013              /* 단축코드 */
                ,   td_etp_basic.F16002                                 AS  f16002              /* 한글종목명 */
                ,   td_etp_basic.F16003                                 AS  f16003              /* 한글종목약명 */
                ,   td_etp_basic.F16017                                 AS  f16017              /* 상장일 */
                ,   DATE_FORMAT( td_etp_basic.F16017, '%Y.%m.%d' )      AS  fmt_f16017          /* format 상장일 */
                ,   td_etp_basic.F15001                                 AS  f15001              /* 현재가 */
                ,   td_etp_basic.F15472                                 AS  f15472              /* 대비 */
                ,   td_etp_basic.F15004                                 AS  f15004              /* 등락율 */
                ,   td_etp_basic.F15006                                 AS  f15006              /* 등락구분(1:상한/2:상승/3:보합/4:하한/5:하락/6:기세상한/7:기세상승/8:기세하한/9:기세하락) */
                ,   td_etp_basic.F15009                                 AS  f15009              /* 시가 */
                ,   td_etp_basic.F15010                                 AS  f15010              /* 고가 */
                ,   td_etp_basic.F15011                                 AS  f15011              /* 저가 */
                ,   td_etp_basic.F15015                                 AS  f15015              /* 거래량 */
                ,   td_etp_basic.F15023                                 AS  f15023              /* 30609동일거래금액 */
                ,   td_etp_basic.F15028                                 AS  f15028              /* 시가총액 */
                ,   td_etp_basic.F15029                                 AS  f15029              /* 시가총액비중 */
                ,   td_etp_basic.F30812                                 AS  f30812              /* 유동시가총액 */
                ,   td_etp_basic.F30813                                 AS  f30813              /* 유동시가총액비중 */
                ,   td_etp_basic.F18438                                 AS  f18438              /* 적용환율 */
                ,   td_etp_basic.F16143                                 AS  f16143              /* 상장주식수 */
                ,   td_etp_basic.F16073                                 AS  f16073              /* 락구분코드 */
                ,   td_etp_basic.F15007                                 AS  f15007              /* 기준가 */
                ,   td_etp_basic.F16493                                 AS  f16493              /* ETP상품구분코드(1:ETF(투자회사형),2:ETF(수익증권형),3:ETN,4:손실제한형ETN) */
                ,   td_etp_basic.F15301                                 AS  f15301              /* ETP지표가치(NAV/IV) */
                ,   td_etp_basic.F15302                                 AS  f15302              /* 추적오차율 */
                ,   td_etp_basic.F15303                                 AS  f15303              /* ETP장중지표가치(iNAV/iIV)대비 */
                ,   td_etp_basic.F15304                                 AS  f15304              /* ETP괴리율 */
                ,   td_etp_basic.F15305                                 AS  f15305              /* ETP괴리도 */
                ,   td_etp_basic.F30818                                 AS  f30818              /* 장중지표가치(iNAV/iIV)등락율 */
                ,   td_etp_basic.F15318                                 AS  f15318              /* ETP기초지수현재가 */
                ,   td_etp_basic.F16497                                 AS  f16497              /* ETF구성종목수 */
                ,   td_etp_basic.F31892                                 AS  f31892              /* 전일현금배당금액 */
                ,   td_etp_basic.F18450                                 AS  f18450              /* 해외ETF원주자산기준통화코드 */
                ,   td_etp_basic.F18001                                 AS  f18001              /* 전일ETF순자산총액(원) */
                ,   td_etp_basic.F16500                                 AS  f16500              /* 전일ETF순자산총액(백만) */
                ,   td_etp_basic.F33307                                 AS  f33307              /* 주식순증감(ETN) */
                ,   td_etp_basic.F33308                                 AS  f33308              /* 상장증권수(ETN) */
                ,   td_etp_basic.F33951                                 AS  f33951              /* ETP기초지수소속시장구분코드 */
                ,   td_etp_basic.F15319                                 AS  f15319              /* ETP기초지수기준대비 */
                ,   td_etp_basic.F30823                                 AS  f30823              /* ETF관련지수등락율 */
                ,   td_etp_basic.F15602                                 AS  f15602              /* ETP장중지표가치(iNAV/iIV) */
                ,   td_etp_basic.F15631                                 AS  f15631              /* ETP지표가치_로그수익률 */
                ,   td_etp_basic.F15632                                 AS  f15632              /* ETP기초지수_로그수익률 */
                ,   td_etp_basic.F15633                                 AS  f15633              /* ETP로그수익률차(15631-15632) */
                ,   td_etp_basic.F19288                                 AS  f19288              /* ETP지표가치_장종료-확정치차(NAV/IV) */
                ,   td_etp_basic.F34515                                 AS  f34515              /* ETF_1CU당금액 */
                ,   td_etp_basic.F16499                                 AS  f16499              /* ETF_CU구성단위 */
                ,   td_etp_basic.F03329                                 AS  f03329              /* 전일ETP지표가치(예탁원)(NAV/IV) */
                ,   td_etp_basic.F18439                                 AS  f18439              /* 적용화폐명 */
                ,   td_etp_basic.F16109                                 AS  f16109              /* 유통주식수 */
                ,   td_etp_basic.F16257                                 AS  f16257              /* ETP기초지수코드 */
                ,   td_etp_basic.F34777                                 AS  f34777              /* ETP기초자산명 */
                ,   td_etp_basic.F34521                                 AS  f34521              /* ETF참고지수MID */
                ,   td_etp_basic.F34776                                 AS  f34776              /* ETF참고지수코드 */
                ,   td_etp_basic.F34514                                 AS  f34514              /* ETF복제방법구분코드(P:실물복제,S:합성복제,A:Active) */
                ,   td_etp_basic.F34239                                 AS  f34239              /* ETP기초지수MID */
                ,   td_etp_basic.F34241                                 AS  f34241              /* ETP지표가치산출구분(K:국내,F:해외) */
                ,   td_etp_basic.F34769                                 AS  f34769              /* ETP지수산출기관코드 */
                ,   td_etp_basic.F34770                                 AS  f34770              /* ETP지수시장대분류 */
                ,   td_etp_basic.F34771                                 AS  f34771              /* ETP지수시장중분류 */
                ,   td_etp_basic.F34772                                 AS  f34772              /* ETP지수시장소분류 */
                ,   td_etp_basic.F34775                                 AS  f34775              /* ETP레버리지인버스구분코드 */
                ,   td_etp_basic.F34778                                 AS  f34778              /* ETP지수자산대분류1 */
                ,   td_etp_basic.F34779                                 AS  f34779              /* ETP지수자산중분류1 */
                ,   td_etp_basic.F34780                                 AS  f34780              /* ETP지수자산소분류1 */
                ,   td_etp_basic.F34781                                 AS  f34781              /* ETP지수자산대분류2 */
                ,   td_etp_basic.F34782                                 AS  f34782              /* ETP지수자산중분류2 */
                ,   td_etp_basic.F34783                                 AS  f34783              /* ETP지수자산소분류2 */
                ,   td_etp_basic.F33960                                 AS  f33960              /* ETP운용사코드 */
                ,   td_etp_basic.F33961                                 AS  f33961              /* ETP운용사명(한글명) */
    ]]>
    </sql>

    <!--
    * IndexBasic 컬럼 SQL 정보를 추출한다.
    * 2019-04-25  bkLove(촤병국)
    -->
    <sql    id="sqlIndexBasic01">
    <![CDATA[
                    td_index_basic.F12506                               AS  f12506              /* 입회일 */
                ,   td_index_basic.F16013                               AS  f16013              /* 단축코드 */
                ,   td_index_basic.F16002                               AS  f16002              /* 한글종목명 */
                ,   td_index_basic.F15009                               AS  f15009              /* 시가 */
                ,   td_index_basic.F15010                               AS  f15010              /* 고가 */
                ,   td_index_basic.F15011                               AS  f15011              /* 저가 */
                ,   td_index_basic.F15001                               AS  f15001              /* 현재가 */
                ,   td_index_basic.F15007                               AS  f15007              /* 기준가 */
                ,   td_index_basic.F15015                               AS  f15015              /* 거래량 */
                ,   td_index_basic.F15023                               AS  f15023              /* 거래대금 */
                ,   td_index_basic.F15472                               AS  f15472              /* 대비 */
                ,   td_index_basic.F15004                               AS  f15004              /* 등락율 */
                ,   td_index_basic.F15006                               AS  f15006              /* 등락구분(1:상한/2:상승/3:보합/4:하한/5:하락/6:기세상한/7:기세상승/8:기세하한/9:기세하락) */
                ,   td_index_basic.F15028                               AS  f15028              /* 시가총액 */
                ,   td_index_basic.large_type                           AS  large_type          /* 지수대분류(FNGUIDE, KRX, KIS, KAP) */
                ,   td_index_basic.middle_type                          AS  middle_type         /* 지수중분류(FNGUIDE, WISEFN) */
                ,   td_index_basic.market_id                            AS  market_id           /* 시장 ID */
                ,   td_index_basic.std_index                            AS  std_index           /* 기준지수 */
                ,   td_index_basic.std_date                             AS  std_date            /* 기준일 */
                ,   DATE_FORMAT( td_index_basic.std_date, '%Y.%m.%d' )  AS  fmt_std_date        /* 기준일 */
                ,   td_index_basic.anno_date                            AS  anno_date           /* 발표일 */
                ,   td_index_basic.index_cal_method                     AS  index_cal_method    /* 지수산출방식 */
                ,   td_index_basic.std_capital                          AS  std_capital         /* 기준시가총액 */
                ,   td_index_basic.fixed_cash                           AS  fixed_cash          /* 고정현금 */
                ,   td_index_basic.flowrate_yn                          AS  flowrate_yn         /* 유동비율적용여부 */
    ]]>
    </sql>    


    <!--
    * ETP 운용관리 - ETP 운영정보를 조회한다.
    * 2019-05-03  bkLove(촤병국)
    -->
    <select id="getEtpOperInfo">

        SELECT      /* etpOper.getEtpOperInfo  ETP 운용관리 - ETP 운영정보를 조회한다. */
                    <include    refid="sqlEtpBasic01" />

                ,   td_index_basic.f16002                                           AS  index_nm            /* 지수명 */
                ,   td_index_basic.f15001                                           AS  index_f15001        /* 지수 현재가 */
                ,   td_index_basic.index_cal_method                                 AS  index_cal_method    /* 지수 산출방식 */

                ,   (
                        SELECT  td_index_basic01.f15001

                          FROM          td_index_hist
                         INNER  JOIN    td_index_basic      td_index_basic01
                            ON  (
                                        td_index_hist.F16013        =   td_index_basic01.F16013
                                    AND td_index_hist.market_id     =   td_index_basic01.market_id
                                )
                         WHERE  1 = 1
                           AND  td_index_hist.F16013        =   td_index_basic.f16013         /* 단축코드 */
                           AND  td_index_hist.market_id     =   td_index_basic.market_id      /* 시장 ID */
                           AND  td_index_hist.F12506        =   DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 1 DAY ), '%Y%m%d' )      /* 입회일자 ( 1일전 ) */
                    )                                                               AS  prev_f15001        /* 기초지수 전일 현재가 */

                ,   1111                                                            AS  week1
                ,   2222222                                                         AS  month1
                ,   333333333                                                       AS  month3
                ,   4444444444                                                      AS  month6
                ,   555555555555555                                                 AS  year1

          FROM          td_etp_basic
          LEFT  JOIN    td_index_basic
            ON  (
                         td_index_basic.F16013           =  td_etp_basic.f16257                                                 /* 단축코드 = ETP기초지수코드 */
                    AND  td_index_basic.MARKET_ID        LIKE    CONCAT( '_' , LPAD( td_etp_basic.f34239, 3, '0' ) , '%' )      /* 시장 ID = ETP기초지수MID */
                )
         WHERE  1 = 1

        <choose>
            <when   test=' f34241 != null  and f34241 == "A" '>
            </when>

            <when   test=' f34241 != null  and f34241 != "I" '>
           AND  td_etp_basic.f34241                 =   #{f34241}                   /* ETP지표가치산출구분(K:국내,F:해외) */
            </when>

            <when   test=' f34241 != null  and f34241  == "I" '>
                /* 관심종목에 존재하는 경우 ( 구분: ETP ) */
           AND  EXISTS
                (
                    SELECT  1
                      FROM  tm_favor_item
                     WHERE  1 = 1
                    
                       AND  tm_favor_item.type_cd   =   #{type_cd}                  /* 사용자 그룹 코드 */
                       AND  tm_favor_item.inst_cd   =   #{inst_cd}                  /* 기관구분코드 */
                       AND  tm_favor_item.email     =   #{user_id}                  /* 이메일 */
                    
                       AND  tm_favor_item.gubun     =   '1'                         /* 구분 : 1, ETP, 2. INDEX */
                       AND  tm_favor_item.f16012    =   td_etp_basic.f16012         /* 국제표준코드 */

                     LIMIT  0, 1
                )
            </when>        
        </choose>

    </select>    


    <!--
    * ETP 운용관리 - 지수관리 를 조회한다.
    * 2019-05-03  bkLove(촤병국)
    -->
    <select id="geEtpOperIndex">

        SELECT      /* etpOper.getEtpOperIndex  ETP 운용관리 - 지수관리 를 조회한다. */
                <include    refid="sqlIndexBasic01" />
                ,   'vendor'                                            AS  vendor
                ,   '1'                                                 AS  manage_type
                ,   '2018.09.05'                                        AS  last_date
                ,   '18:00:01'                                          AS  last_time

                ,   td_etp_basic.f16012                                 AS  f16012          /* 국제표준코드 */
                ,   td_etp_basic.f16002                                 AS  f16002          /* 한글종목명 */

          FROM          td_index_basic
         INNER  JOIN    td_etp_basic
                  ON    (           td_index_basic.f16013       =       td_etp_basic.f16257
                                AND td_index_basic.market_id    LIKE    CONCAT( '_', LPAD( td_etp_basic.f34239, 3, '0' ), '%' )
                        )
         WHERE  1 = 1         

    </select>


    <!--
    * ETP 운용관리 - 지수관리 - 해외지수 종가 모니터링을 조회한다.
    * 2019-05-03  bkLove(촤병국)
    -->
    <select id="geEtpOperIndexOversea">

        SELECT      /* etpOper.geEtpOperIndexOversea  ETP 운용관리 - 지수관리 - 해외지수 종가 모니터링을 조회한다. */
                    <include    refid="sqlEtpBasic01" />
    <![CDATA[
                ,   'OK'                                            AS  in_out          /* 입수 구분 */
                ,   'S&P GCCI1'                                     AS  degree          /* 차수 */
                ,   'S&P GCCI1'                                     AS  real_symbol     /* 실시간 심볼 */
                ,   'S&P GCCI1'                                     AS  incre_symbol    /* 증가 심볼 */
                ,   '2018.04.01'                                    AS  rest_date       /* 휴장일 */
                ,   '2018.04.01'                                    AS  recently_date   /* 최근일자 */
                ,   11111111                                        AS  incre_recently  /* 최근증가 */
                ,   '2018.04.01'                                    AS  base_date       /* 기준일자 */
    ]]>
          FROM  td_etp_basic
         WHERE  1 = 1
           AND  td_etp_basic.f16257     REGEXP  '[^0-9]'       /* 첫글자가 0-9가 아닌 것 해외지수로 임시 간주. 추후 수정 필요. */

    </select>

    <!--
    * ETP 운용관리 - 지수관리 - 오류내역을 조회한다.
    * 2019-05-03  bkLove(촤병국)
    -->
    <select id="geEtpOperIndexError">

        SELECT      /* etpOper.geEtpOperIndexError  ETP 운용관리 - 지수관리 - 오류내역을 조회한다. */

                    base.err_id                                                 AS  err_id          /* err_id */
                ,   base.err_date                                               AS  err_date        /* 날짜 */
                ,   base.err_time                                               AS  err_time        /* 발생시간 */
                ,   base.fix_time                                               AS  fix_time        /* 조치시간 */
                ,   base.err_content                                            AS  err_content      /* 오류내용 */
                ,   base.remark                                                 AS  remark           /* 비고 */

          FROM  (
                    SELECT      'err_dbf_18090101'                              AS  err_id          /* err_id */
                            ,   '2018.09.10'                                    AS  err_date        /* 날짜 */
                            ,   '06:30:10'                                      AS  err_time        /* 발생시간 */
                            ,   '07:00:00'                                      AS  fix_time        /* 조치시간 */
                            ,   '지수 연속성 불일치'                             AS  err_content      /* 오류내용 */
                            ,   '장전처리 완료됨'                                AS  remark           /* 비고 */
                    FROM  dual
                   WHERE  1 = 1

                    UNION   ALL

                    SELECT      'err_dbf_18090102'                              AS  err_id          /* err_id */
                            ,   '2018.09.11'                                    AS  err_date        /* 날짜 */
                            ,   '07:30:10'                                      AS  err_time        /* 발생시간 */
                            ,   '08:00:00'                                      AS  fix_time        /* 조치시간 */
                            ,   '지수 재배치 작업'                               AS  err_content      /* 오류내용 */
                            ,   '장전처리 완료됨'                                AS  remark           /* 비고 */
                    FROM  dual
                   WHERE  1 = 1

                    UNION   ALL

                    SELECT      'err_dbf_18090103'                              AS  err_id          /* err_id */
                            ,   '2018.09.12'                                    AS  err_date        /* 날짜 */
                            ,   '08:30:10'                                      AS  err_time        /* 발생시간 */
                            ,   '09:00:00'                                      AS  fix_time        /* 조치시간 */
                            ,   '지수 (종가) 입수 지연'                          AS  err_content      /* 오류내용 */
                            ,   '송출오류'                                      AS  remark           /* 비고 */
                    FROM  dual
                   WHERE  1 = 1                                       
                )       base

         WHERE  1 = 1
    </select>    

</mapper>