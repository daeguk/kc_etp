<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="EtpRegister">  
    <!--



    
    * etp 신청현황조회
    * 
    -->
<select id="selectEtpApplyList" >
       <![CDATA[
       SELECT a.*, 
        (select inst_nm from m001uetpinstcode where inst_cd = a.inst_cd limit 1) inst_nm, 
        (select m_cd_nm from m001uetpcode where l_cd= '002' and m_cd = a.isin_stat_cd) m_cd_nm,
        timestampdiff(day,req_date,now()) lapse_date,
        timestampdiff(day,ifnull(list_date,"29991231")  ,now()) list_lapse_date, 
        ifnull(a.ridx_dist_sym_code,a.idx_sym_code) basic_idx,
        case a.kor_for_type
        when "K" then "국내"
        when "F" then "해외"        
        else ""
        end kor_for_type_name 
        from m001uetpmaster a
        WHERE (a.list_date    >=   current_date( )  or      a.list_date is null) 
        and a.isin_stat_cd != "0009" 
       ]]>
        <if test=" userType == '0001' "> 
       <![CDATA[
        and    a.inst_cd = #{instCd} 
       ]]>
       </if> 
       order by a.seq asc
   
</select>

<select id="getEtpApplyDistCnt">
       <![CDATA[
       select count(1)  distCnt from m001uetpmaster where (list_date >=   current_date( )  or   list_date is null  )
       ]]>
       <if test=" userType == '0001' "> 
       <![CDATA[
        and    a.inst_cd = #{instCd} 
       ]]>
       </if> 
        and idx_dis_yn = 'Y' and isin_stat_cd != '0009'
</select>
<select id="getEtpApplyIndexCnt" >
       <![CDATA[
       select count(1) indexCnt from m001uetpmaster where  (list_date >=   current_date( )  or   list_date is null  )
       ]]>
       <if test=" userType == '0001' "> 
       <![CDATA[
        and    a.inst_cd = #{instCd} 
       ]]>
       </if> 
        and idx_rec_yn = 'Y' and isin_stat_cd != '0009'
</select>

<select id="getEtpApplyCodeCnt">
       <![CDATA[
       select count(1) codeCnt from m001uetpmaster where  (list_date >=   current_date( )  or   list_date is null  )
       ]]>
       <if test=" userType == '0001' "> 
       <![CDATA[
        and    a.inst_cd = #{instCd} 
       ]]>
       </if>
       and isin_code is not null and isin_stat_cd != '0009'
</select>

<select id="getEtpApplyInavCnt" >
       <![CDATA[
       select count(1) inavCnt from m001uetpmaster where  (list_date >=   current_date( )  or   list_date is null  )
       ]]>
       <if test=" userType == '0001' "> 
       <![CDATA[
        and    a.inst_cd = #{instCd} 
       ]]>
       </if>
       and inav_calc_yn = 'Y' and isin_stat_cd != '0009'
</select>
<select id="getCodeList">
 <![CDATA[
    SELECT
        L_CD
        ,L_CD_NM
        ,M_CD
        ,M_CD_NM
    FROM m001uetpcode
    WHERE L_CD = #{lCd}
 ]]>	   
</select>


<select id="getCompList">		
 <![CDATA[
    SELECT
        DISTINCT INST_CD, INST_NM, USER_TYPE
    FROM m001uetpinstcode
]]>    
    <where>
        <if test="userType != null and userType != ''">
         <![CDATA[    AND USER_TYPE = #{userType}]]>
        </if>
    </where>
  <![CDATA[   
    ORDER BY INST_NM

]]>	    
</select>

<select id="getCompContactList">
<![CDATA[   
    SELECT USER_NM,TEL_NO,CEL_NO,EMAIL 
        FROM m001uetpinstcode
        WHERE INST_CD = #{inst_cd}
]]>	        
</select>



<select id="getMaster">
 <![CDATA[
        SELECT
        	A.seq ,A.isu_kor_nm ,A.isu_eng_nm ,A.isin_code ,A.isu_srt_cd ,A.etp_type ,A.inst_cd ,A.req_date ,A.list_req_date ,A.list_date ,A.krx_dist_yn ,A.comp_dist_yn ,A.ksd_dist_yn ,A.mirae_dist_yn ,A.idx_inst_cd ,A.idx_sym_code ,A.idx_nm ,A.idx_dist_inst_cd ,A.idx_close_type ,A.idx_holy_cd ,A.idx_trace_yd_mult_type ,A.pre_idx_type ,A.idx_file_nm ,A.idx_comp_ksd_dist_yn ,A.idx_comp_mirae_dist_yn ,A.blom_ticker ,A.user_req ,A.real_yn ,A.ridx_inst_cd ,A.ridx_dist_inst_cd ,A.ridx_crt_sym_code ,A.ridx_dist_sym_code ,A.ridx_holy_cd ,A.ridx_krx_dist_yn ,A.ridx_comp_dist_yn ,A.ridx_ksd_dist_yn ,A.ridx_mirae_dist_yn ,A.ridx_dist_term ,A.refidx_sym_code ,A.refidx_nm ,A.refidx_inst_cd ,A.refidx_file_nm ,A.refidx_req ,A.refidx_blom_ticker ,A.ex_rate_cd ,A.ex_hedge_yn ,A.isin_stat_cd ,A.inav_calc_cd ,A.idx_rec_yn ,A.idx_dis_yn ,A.inav_calc_yn ,A.idx_mid ,A.ridx_mid ,A.close_file ,A.real_idx_tr ,A.proc_stat ,A.insert_id ,A.insert_time ,A.update_id ,A.update_time ,A.kor_for_type ,A.agent_cd ,A.idx_comp_cd ,A.krx_up_code ,A.agent_up_code 
			,IFNULL((SELECT INST_NM FROM m001uetpinstcode WHERE INST_CD = A.INST_CD LIMIT 1), '') AS INST_NM
        FROM m001uetpmaster A        
		WHERE A.SEQ = #{seq}
 ]]>       
</select>

<insert id="insertMaster" >
 <![CDATA[
    INSERT INTO m001uetpmaster (
        SEQ, INST_CD, ISU_KOR_NM, ISU_ENG_NM, ISIN_CODE, ISU_SRT_CD, ETP_TYPE, LIST_REQ_DATE, LIST_DATE
        ,IDX_SYM_CODE, IDX_NM, IDX_INST_CD, IDX_DIST_INST_CD, IDX_HOLY_CD, IDX_TRACE_YD_MULT_TYPE
        ,IDX_CLOSE_TYPE, PRE_IDX_TYPE, IDX_FILE_NM, IDX_COMP_KSD_DIST_YN, IDX_COMP_MIRAE_DIST_YN
        ,BLOM_TICKER, EX_RATE_CD, COMP_DIST_YN, KRX_DIST_YN, KSD_DIST_YN, MIRAE_DIST_YN, USER_REQ
        ,REAL_YN, RIDX_INST_CD, RIDX_CRT_SYM_CODE, RIDX_DIST_INST_CD, RIDX_DIST_SYM_CODE, RIDX_HOLY_CD
        ,RIDX_COMP_DIST_YN, RIDX_KRX_DIST_YN, RIDX_KSD_DIST_YN, RIDX_MIRAE_DIST_YN, EX_HEDGE_YN, RIDX_DIST_TERM
        ,REFIDX_SYM_CODE, REFIDX_NM, REFIDX_INST_CD, REFIDX_FILE_NM, REFIDX_BLOM_TICKER, REFIDX_REQ, INAV_CALC_CD
        ,IDX_REC_YN, IDX_DIS_YN, INAV_CALC_YN, IDX_MID, RIDX_MID, CLOSE_FILE, REAL_IDX_TR, PROC_STAT
        ,ISIN_STAT_CD, REQ_DATE, INSERT_ID, INSERT_TIME
        ,KOR_FOR_TYPE, AGENT_CD, IDX_COMP_CD, KRX_UP_CODE, AGENT_UP_CODE
    ) VALUES (
        #{seq},#{inst_cd},#{isu_kor_nm},#{isu_eng_nm},#{isin_code},#{isu_srt_cd},#{etp_type},#{list_req_date},#{list_date}
        ,#{idx_sym_code},#{idx_nm},#{idx_inst_cd},#{idx_dist_inst_cd},#{idx_holy_cd},#{idx_trace_yd_mult_type}
        ,#{idx_close_type},#{pre_idx_type},#{idx_file_nm},#{idx_comp_ksd_dist_yn},#{idx_comp_mirae_dist_yn}
        ,#{blom_ticker},#{ex_rate_cd},#{comp_dist_yn},#{krx_dist_yn},#{ksd_dist_yn},#{mirae_dist_yn},#{user_req}
        ,#{real_yn},#{ridx_inst_cd},#{ridx_crt_sym_code},#{ridx_dist_inst_cd},#{ridx_dist_sym_code},#{ridx_holy_cd}
        ,#{ridx_comp_dist_yn},#{ridx_krx_dist_yn},#{ridx_ksd_dist_yn},#{ridx_mirae_dist_yn},#{ex_hedge_yn},#{ridx_dist_term}
        ,#{refidx_sym_code},#{refidx_nm},#{refidx_inst_cd},#{refidx_file_nm},#{refidx_blom_ticker},#{refidx_req},#{inav_calc_cd}
        ,#{idx_rec_yn},#{idx_dis_yn},#{inav_calc_yn},#{idx_mid},#{ridx_mid},#{close_file},#{real_idx_tr},#{proc_stat}
        ,#{isin_stat_cd},#{req_date},#{insert_id}, date_format(now(), '%Y%m%d%H%i%s')	
        ,#{kor_for_type},#{agent_cd},#{idx_comp_cd},#{krx_up_code},#{agent_up_code}
    )
 ]]>     
</insert>

<update id="updateMaster" >
    <![CDATA[ UPDATE m001uetpmaster ]]> 
    <set>
        <if test="isu_kor_nm != null and isu_kor_nm !=''">	
         <![CDATA[ ISU_KOR_NM 				= #{isu_kor_nm} ]]> 
        </if>	
        <if test="isu_eng_nm != null and isu_eng_nm !=''">			
        <![CDATA[,ISU_ENG_NM 			= #{isu_eng_nm}]]> 
        </if>
        <if test="isin_code != null and isin_code !=''">			
        <![CDATA[,ISIN_CODE 				= #{isin_code}	]]> 
        </if>		
        <if test="isu_srt_cd != null and isu_srt_cd !=''">
        ,ISU_SRT_CD 			= #{isu_srt_cd}	
         </if>	
        <if test="etp_type != null and etp_type !=''">		
        ,ETP_TYPE 				= #{etp_type}
        </if>			
        <if test="listReqDate != null and listReqDate !=''">		
        ,LIST_REQ_DATE 			= #{listReqDate}	
        </if>
        <if test="listDate != null and listDate !=''">		
        ,LIST_DATE 				= #{listDate}			
        </if> 
        <if test="idx_sym_code != null and idx_sym_code !=''">                                                       
        ,IDX_SYM_CODE 			= #{idx_sym_code}
        </if>		
        <if test="idx_nm != null and idx_nm !=''"> 
        ,IDX_NM 				= #{idx_nm}
         </if>
        <if test="idx_inst_cd != null and idx_inst_cd !=''"> 				
        ,IDX_INST_CD 			= #{idx_inst_cd}
        </if>
        <if test="idx_dist_inst_cd != null and idx_dist_inst_cd !=''"> 				
        ,IDX_DIST_INST_CD 		= #{idx_dist_inst_cd}
        </if>
        <if test="idx_holy_cd != null and idx_holy_cd !=''"> 		
        ,IDX_HOLY_CD 			= #{idx_holy_cd}		
        </if>
        <if test="idx_trace_yd_mult_type != null and idx_trace_yd_mult_type !=''"> 	
        ,IDX_TRACE_YD_MULT_TYPE = #{idx_trace_yd_mult_type}
        </if>
        <if test="idx_close_type != null and idx_close_type !=''"> 
        ,IDX_CLOSE_TYPE 		= #{idx_close_type}
        </if>
        <if test="pre_idx_type != null and pre_idx_type !=''"> 		 
        ,PRE_IDX_TYPE 			= #{pre_idx_type}			
        </if>
        <if test="idx_file_nm != null and idx_file_nm !=''"> 	
        ,IDX_FILE_NM 			= #{idx_file_nm}
        </if>
        <if test="idx_comp_ksd_dist_yn != null and idx_comp_ksd_dist_yn !=''">			
        ,IDX_COMP_KSD_DIST_YN 	= #{idx_comp_ksd_dist_yn}
        </if>
        <if test="idx_comp_mirae_dist_yn != null and idx_comp_mirae_dist_yn !=''">	
        ,IDX_COMP_MIRAE_DIST_YN = #{idx_comp_mirae_dist_yn}
        </if>
        <if test="blom_ticker != null and blom_ticker !=''">	
        ,BLOM_TICKER 			= #{blom_ticker}
        </if>
        <if test="ex_rate_cd != null and ex_rate_cd !=''">			
        ,EX_RATE_CD 			= #{ex_rate_cd}			 
        </if>
        <if test="comp_dist_yn != null and comp_dist_yn !=''">	
        ,COMP_DIST_YN 			= #{comp_dist_yn}
        </if>
        <if test="krx_dist_yn != null and krx_dist_yn !=''">			
        ,KRX_DIST_YN 			= #{krx_dist_yn}
        </if>
        <if test="ksd_dist_yn != null and ksd_dist_yn !=''">			
        ,KSD_DIST_YN 			= #{ksd_dist_yn}
        </if>
        <if test="mirae_dist_yn != null and mirae_dist_yn !=''">				
        ,MIRAE_DIST_YN 			= #{mirae_dist_yn}
        </if>
        <if test="user_req != null and user_req !=''">			
        ,USER_REQ 				= #{user_req}			 
        </if>
        <if test="real_yn != null and real_yn !=''">	
        ,REAL_YN				= #{real_yn}
        </if>
        <if test="ridx_inst_cd != null and ridx_inst_cd !=''">			
        ,RIDX_INST_CD 			= #{ridx_inst_cd}
        </if>
        <if test="ridx_crt_sym_code != null and ridx_crt_sym_code !=''">		
        ,RIDX_CRT_SYM_CODE 		= #{ridx_crt_sym_code}
        </if>
        <if test="ridx_dist_inst_cd != null and ridx_dist_inst_cd !=''">		
        ,RIDX_DIST_INST_CD 		= #{ridx_dist_inst_cd}
        </if>
        <if test="ridx_dist_sym_code != null and ridx_dist_sym_code !=''">	
        ,RIDX_DIST_SYM_CODE 	= #{ridx_dist_sym_code}
        </if>
        <if test="ridx_holy_cd != null and ridx_holy_cd !=''">	
        ,RIDX_HOLY_CD 			= #{ridx_holy_cd}
        </if>
        <if test="ridx_comp_dist_yn != null and ridx_comp_dist_yn !=''">			
        ,RIDX_COMP_DIST_YN 		= #{ridx_comp_dist_yn}
        </if>
        <if test="ridx_krx_dist_yn != null and ridx_krx_dist_yn !=''">	
        ,RIDX_KRX_DIST_YN 		= #{ridx_krx_dist_yn}
        </if>	
        <if test="ridx_ksd_dist_yn != null and ridx_ksd_dist_yn !=''">
        ,RIDX_KSD_DIST_YN 		= #{ridx_ksd_dist_yn}
        </if>
        <if test="ridx_mirae_dist_yn != null and ridx_mirae_dist_yn !=''">	
        ,RIDX_MIRAE_DIST_YN 	= #{ridx_mirae_dist_yn}	
        </if>
        <if test="ex_hedge_yn != null and ex_hedge_yn !=''">	
        ,EX_HEDGE_YN 			= #{ex_hedge_yn}
        </if>
        <if test="ridx_dist_term != null and ridx_dist_term !=''">		
        ,RIDX_DIST_TERM 		= #{ridx_dist_term}		
        </if> 
        <if test="refidx_sym_code != null and refidx_sym_code !=''">                                              
        ,REFIDX_SYM_CODE 		= #{refidx_sym_code}
        </if>
        <if test="refidx_nm != null and refidx_nm !=''">    	
        ,REFIDX_NM 				= #{refidx_nm}			
        </if>
        <if test="refidx_inst_cd != null and refidx_inst_cd !=''">  
        ,REFIDX_INST_CD 		= #{refidx_inst_cd}
        </if>
        <if test="refidx_file_nm != null and refidx_file_nm !=''"> 		
        ,REFIDX_FILE_NM 		= #{refidx_file_nm}		
        </if>
        <if test="refidx_blom_ticker != null and refidx_blom_ticker !=''"> 	
        ,REFIDX_BLOM_TICKER 	= #{refidx_blom_ticker}
        </if>
        <if test="refidx_req != null and refidx_req !=''">	
        ,REFIDX_REQ 			= #{refidx_req}				
        </if>
        <if test="inav_calc_cd != null and inav_calc_cd !=''">	
        ,INAV_CALC_CD 			= #{inav_calc_cd}		
        </if>
        <if test="idx_rec_yn != null and idx_rec_yn !=''">
        ,IDX_REC_YN 			= #{idx_rec_yn}
        </if>
        <if test="idx_dis_yn != null and idx_dis_yn !=''">			 
        ,IDX_DIS_YN 			= #{idx_dis_yn}			 
        </if>
        <if test="inav_calc_yn != null and inav_calc_yn !=''">
        ,INAV_CALC_YN 			= #{inav_calc_yn}
        </if>
        <if test="idx_mid != null and idx_mid !=''">			
        ,IDX_MID 				= #{idx_mid}
        </if>				
        <if test="ridx_mid != null and ridx_mid !=''">			
        ,RIDX_MID 				= #{ridx_mid}	
        </if>
        <if test="close_file != null and close_file !=''">
        ,CLOSE_FILE 			= #{close_file}
        </if>
        <if test="real_idx_tr != null and real_idx_tr !=''">		
        ,REAL_IDX_TR 			= #{real_idx_tr}
        </if>
        <if test="proc_stat != null and proc_stat !=''">
        ,PROC_STAT 				= #{proc_stat}			 
        </if>
        <if test="user_id != null and user_id !=''">
        ,UPDATE_ID				= #{user_id}
        </if>					 
        ,UPDATE_TIME			=  date_format(now(), '%Y%m%d%H%i%s')	
        <if test="isin_stat_cd != null and isin_stat_cd !=''">
        ,ISIN_STAT_CD			= #{isin_stat_cd}
        </if>	
        <if test="kor_for_type != null and kor_for_type !=''">		
        ,KOR_FOR_TYPE			= #{kor_for_type}
        </if>
        <if test="agent_cd != null and agent_cd !=''">				
        ,AGENT_CD				= #{agent_cd}
        </if>
        <if test="idx_comp_cd != null and idx_comp_cd !=''">				 
        ,IDX_COMP_CD			= #{idx_comp_cd}			
        </if>
        <if test="krx_up_code != null and krx_up_code !=''">	
        ,KRX_UP_CODE			= #{krx_up_code}
        </if>
        <if test="agent_up_code != null and agent_up_code !=''">			
        ,AGENT_UP_CODE			= #{agent_up_code}
        </if>
    </set> 	
    WHERE SEQ = #{seq}
</update>

<insert id="insertMasterHistory" >
    <![CDATA[
    INSERT INTO m001uetpmasterh ( ]]> 
        SEQ_MASTER,SEQ_HIST,INST_CD, ISU_KOR_NM, ISU_ENG_NM, ISIN_CODE, ISU_SRT_CD, ETP_TYPE
        ,IDX_SYM_CODE, IDX_NM, IDX_INST_CD, IDX_DIST_INST_CD, IDX_HOLY_CD, IDX_TRACE_YD_MULT_TYPE
        ,IDX_CLOSE_TYPE, PRE_IDX_TYPE, IDX_FILE_NM, IDX_COMP_KSD_DIST_YN, IDX_COMP_MIRAE_DIST_YN
        ,BLOM_TICKER, EX_RATE_CD, COMP_DIST_YN, KRX_DIST_YN, KSD_DIST_YN, MIRAE_DIST_YN, USER_REQ
        ,RIDX_INST_CD, RIDX_CRT_SYM_CODE, RIDX_DIST_INST_CD, RIDX_DIST_SYM_CODE, RIDX_HOLY_CD
        ,RIDX_COMP_DIST_YN, RIDX_KRX_DIST_YN, RIDX_KSD_DIST_YN, RIDX_MIRAE_DIST_YN, EX_HEDGE_YN, RIDX_DIST_TERM
        ,REFIDX_SYM_CODE, REFIDX_NM, REFIDX_INST_CD, REFIDX_FILE_NM, REFIDX_BLOM_TICKER, REFIDX_REQ, INAV_CALC_CD
        ,IDX_REC_YN, IDX_DIS_YN, INAV_CALC_YN, IDX_MID, RIDX_MID, CLOSE_FILE, REAL_IDX_TR, PROC_STAT, REAL_YN
        ,ISIN_STAT_CD, REQ_DATE, INSERT_ID, INSERT_TIME, UPDATE_ID, UPDATE_TIME
        ,KOR_FOR_TYPE, AGENT_CD, IDX_COMP_CD, KRX_UP_CODE, AGENT_UP_CODE
        <if test="listReqDate != null and listReqDate !=''">
        , LIST_REQ_DATE, 
         </if>
        <if test="listDate != null and agent_up_listDatecode !=''">	
        ,LIST_DATE
        </if>
    ) VALUES (
      
            #{seq}, #{seq_hist},#{inst_cd},#{isu_kor_nm},#{isu_eng_nm},#{isin_code},#{isu_srt_cd},#{etp_type}
            ,#{idx_sym_code},#{idx_nm},#{idx_inst_cd},#{idx_dist_inst_cd},#{idx_holy_cd},#{idx_trace_yd_mult_type}
            ,#{idx_close_type},#{pre_idx_type},#{idx_file_nm},#{idx_comp_ksd_dist_yn},#{idx_comp_mirae_dist_yn}
            ,#{blom_ticker},#{ex_rate_cd},#{comp_dist_yn},#{krx_dist_yn},#{ksd_dist_yn},#{mirae_dist_yn},#{user_req}
            ,#{ridx_inst_cd},#{ridx_crt_sym_code},#{ridx_dist_inst_cd},#{ridx_dist_sym_code},#{ridx_holy_cd}
            ,#{ridx_comp_dist_yn},#{ridx_krx_dist_yn},#{ridx_ksd_dist_yn},#{ridx_mirae_dist_yn},#{ex_hedge_yn},#{ridx_dist_term}
            ,#{refidx_sym_code},#{refidx_nm},#{refidx_inst_cd},#{refidx_file_nm},#{refidx_blom_ticker},#{refidx_req},#{inav_calc_cd}
            ,#{idx_rec_yn},#{idx_dis_yn},#{inav_calc_yn},#{idx_mid},#{ridx_mid},#{close_file},#{real_idx_tr},#{proc_stat},#{real_yn}
            ,#{isin_stat_cd},#{req_date},#{insert_id} ,date_format(now(), '%Y%m%d%H%i%s'), #{update_id} ,date_format(now(), '%Y%m%d%H%i%s') 
            ,#{kor_for_type},#{agent_cd},#{idx_comp_cd},#{krx_up_code},#{agent_up_code}
            <if test="listReqDate != null and listReqDate !=''">	
                ,#{listReqDate},
            </if>
            <if test="listDate != null and agent_up_listDatecode !=''">	
                #{listDate}
            </if>
    )
   
</insert>

</mapper>