<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="etpDetail">

    <!--
    * EtpBasic 의 기본정보를 조회한다.
    * 2019-04-25  bkLove(촤병국)
    -->
    <select id="getEtpBasic">
    <![CDATA[
        SELECT      /* etpinfo.getEtpBasic EtpBasic 의 기본정보를 조회한다. */

                    DATE_FORMAT( td_etp_basic.F12506, '%Y.%m.%d' )      AS  f12506              /* 입회일 */
                ,   td_etp_basic.F16012                                 AS  f16012              /* 국제표준코드 */
                ,   td_etp_basic.F16013                                 AS  f16013              /* 단축코드 */
                ,   td_etp_basic.F16002                                 AS  f16002              /* 한글종목명 */
                ,   td_etp_basic.F16003                                 AS  f16003              /* 한글종목약명 */
                ,   td_etp_basic.F16017                                 AS  f16017              /* 상장일 */
                ,   td_etp_basic.F15001                                 AS  f15001              /* 현재가 */
                ,   td_etp_basic.F15472                                 AS  f15472              /* 대비 */
                ,   td_etp_basic.F15004                                 AS  f15004              /* 등락율 */
                ,   td_etp_basic.F15006                                 AS  f15006              /* 등락구분(1:상한/2:상승/3:보합/4:하한/5:하락/6:기세상한/7:기세상승/8:기세하한/9:기세하락) */
                ,   td_etp_basic.F15009                                 AS  f15009              /* 시가 */
                ,   td_etp_basic.F15010                                 AS  f15010              /* 고가 */
                ,   td_etp_basic.F15011                                 AS  f15011              /* 저가 */
                ,   td_etp_basic.F15015                                 AS  f15015              /* 거래량 */
                ,   td_etp_basic.F15023                                 AS  f15023              /* 30609동일거래금액 */
                ,   td_etp_basic.F15028                                 AS  f15028              /* 시가총액 */
                ,   td_etp_basic.F15029                                 AS  f15029              /* 시가총액비중 */
                ,   td_etp_basic.F30812                                 AS  f30812              /* 유동시가총액 */
                ,   td_etp_basic.F30813                                 AS  f30813              /* 유동시가총액비중 */
                ,   td_etp_basic.F18438                                 AS  f18438              /* 적용환율 */
                ,   td_etp_basic.F16143                                 AS  f16143              /* 상장주식수 */
                ,   td_etp_basic.F16073                                 AS  f16073              /* 락구분코드 */
                ,   td_etp_basic.F15007                                 AS  f15007              /* 기준가 */
                ,   td_etp_basic.F16493                                 AS  f16493              /* ETP상품구분코드(1:ETF(투자회사형),2:ETF(수익증권형),3:ETN,4:손실제한형ETN) */
                ,   td_etp_basic.F15301                                 AS  f15301              /* ETP지표가치(NAV/IV) */
                ,   td_etp_basic.F15302                                 AS  f15302              /* 추적오차율 */
                ,   td_etp_basic.F15303                                 AS  f15303              /* ETP장중지표가치(iNAV/iIV)대비 */
                ,   td_etp_basic.F15304                                 AS  f15304              /* ETP괴리율 */
                ,   td_etp_basic.F15305                                 AS  f15305              /* ETP괴리도 */
                ,   td_etp_basic.F30818                                 AS  f30818              /* 장중지표가치(iNAV/iIV)등락율 */
                ,   td_etp_basic.F15318                                 AS  f15318              /* ETP기초지수현재가 */
                ,   td_etp_basic.F16497                                 AS  f16497              /* ETF구성종목수 */
                ,   td_etp_basic.F31892                                 AS  f31892              /* 전일현금배당금액 */
                ,   td_etp_basic.F18450                                 AS  f18450              /* 해외ETF원주자산기준통화코드 */
                ,   td_etp_basic.F18001                                 AS  f18001              /* 전일ETF순자산총액(원) */
                ,   td_etp_basic.F16500                                 AS  f16500              /* 전일ETF순자산총액(백만) */
                ,   td_etp_basic.F33307                                 AS  f33307              /* 주식순증감(ETN) */
                ,   td_etp_basic.F33308                                 AS  f33308              /* 상장증권수(ETN) */
                ,   td_etp_basic.F33951                                 AS  f33951              /* ETP기초지수소속시장구분코드 */
                ,   td_etp_basic.F15319                                 AS  f15319              /* ETP기초지수기준대비 */
                ,   td_etp_basic.F30823                                 AS  f30823              /* ETF관련지수등락율 */
                ,   td_etp_basic.F15602                                 AS  f15602              /* ETP장중지표가치(iNAV/iIV) */
                ,   td_etp_basic.F15631                                 AS  f15631              /* ETP지표가치_로그수익률 */
                ,   td_etp_basic.F15632                                 AS  f15632              /* ETP기초지수_로그수익률 */
                ,   td_etp_basic.F15633                                 AS  f15633              /* ETP로그수익률차(15631-15632) */
                ,   td_etp_basic.F19288                                 AS  f19288              /* ETP지표가치_장종료-확정치차(NAV/IV) */
                ,   td_etp_basic.F34515                                 AS  f34515              /* ETF_1CU당금액 */
                ,   td_etp_basic.F16499                                 AS  f16499              /* ETF_CU구성단위 */
                ,   td_etp_basic.F03329                                 AS  f03329              /* 전일ETP지표가치(예탁원)(NAV/IV) */
                ,   td_etp_basic.F18439                                 AS  f18439              /* 적용화폐명 */
                ,   td_etp_basic.F16109                                 AS  f16109              /* 유통주식수 */
                ,   td_etp_basic.F16257                                 AS  f16257              /* ETP기초지수코드 */
                ,   td_etp_basic.F34777                                 AS  f34777              /* ETP기초자산명 */
                ,   td_etp_basic.F34521                                 AS  f34521              /* ETF참고지수MID */
                ,   td_etp_basic.F34776                                 AS  f34776              /* ETF참고지수코드 */
                ,   td_etp_basic.F34514                                 AS  f34514              /* ETF복제방법구분코드(P:실물복제,S:합성복제,A:Active) */
                ,   td_etp_basic.F34239                                 AS  f34239              /* ETP기초지수MID */
                ,   td_etp_basic.F34241                                 AS  f34241              /* ETP지표가치산출구분(K:국내,F:해외) */
                ,   td_etp_basic.F34769                                 AS  f34769              /* ETP지수산출기관코드 */
                ,   td_etp_basic.F34770                                 AS  f34770              /* ETP지수시장대분류 */
                ,   td_etp_basic.F34771                                 AS  f34771              /* ETP지수시장중분류 */
                ,   td_etp_basic.F34772                                 AS  f34772              /* ETP지수시장소분류 */
                ,   td_etp_basic.F34775                                 AS  f34775              /* ETP레버리지인버스구분코드 */
                ,   td_etp_basic.F34778                                 AS  f34778              /* ETP지수자산대분류1 */
                ,   td_etp_basic.F34779                                 AS  f34779              /* ETP지수자산중분류1 */
                ,   td_etp_basic.F34780                                 AS  f34780              /* ETP지수자산소분류1 */
                ,   td_etp_basic.F34781                                 AS  f34781              /* ETP지수자산대분류2 */
                ,   td_etp_basic.F34782                                 AS  f34782              /* ETP지수자산중분류2 */
                ,   td_etp_basic.F34783                                 AS  f34783              /* ETP지수자산소분류2 */
                ,   td_etp_basic.F33960                                 AS  f33960              /* ETP운용사코드 */
                ,   td_etp_basic.F33961                                 AS  f33961              /* ETP운용사명(한글명) */
                
          FROM  td_etp_basic
         WHERE  td_etp_basic.f16012                 =   #{f16012}       /* 국제표준코드 */
    ]]>
    </select>

    <!--
    * ETP 차트 정보를 조회한다.
    * 2019-04-25  bkLove(촤병국)
    -->
    <select id="getEtpChartData">

        <if test= 'term != null  and  term == "1D"' >
        /* 1일 */
    <![CDATA[
        SELECT      td_etp_intra.F20044                                     AS  yyyymmdd            /* 입회일자 */
                ,   DATE_FORMAT( td_etp_intra.F20044, "%Y.%m.%d" )          AS  fmt_yyyymmdd        /* 입회일자 */   
                ,   SUBSTR( LPAD( td_etp_intra.F20004, 8, '0' ) , 1, 2 )    AS  hh24                /* 체결인트라생성시각 */
                ,   SUM( td_etp_intra.F20008 )                              AS  now_price           /* 인트라종가 */
                ,   MAX( td_etp_basic.F16002 )                              AS  etp_nm              /* 한글종목명 */
                
          FROM          kc_etp.td_etp_basic
         INNER  JOIN    td_etp_intra
                  ON    (
                                    td_etp_basic.F16013     =   td_etp_intra.F16013                 /* 단축코드 */

                                    /* 1일 */
                            AND     td_etp_intra.F20044     >=   DATE_FORMAT( DATE_SUB( '20190410', INTERVAL 1 DAY ), '%Y%m%d' )   /* 인트라체결일자 */
                        )
         WHERE  1 = 1
           AND  td_etp_basic.F16012     =   #{f16012}                       /* 국제표준코드 */

         GROUP  BY      td_etp_intra.F20044
                    ,   SUBSTR( LPAD( td_etp_intra.F20004, 8, '0' ) , 1, 2 )
    ]]>
        </if>

        <if test= 'term != null  and  term == "1W" ' >
        /* 1주 */
    <![CDATA[
        SELECT      td_etp_intra.F20044                                     AS  yyyymmdd            /* 입회일자 */
                ,   DATE_FORMAT( td_etp_intra.F20044, "%Y.%m.%d" )          AS  fmt_yyyymmdd        /* 입회일자 */   
                ,   '00'                                                    AS  hh24                /* 체결인트라생성시각 */
                ,   td_etp_intra.F20008                                     AS  now_price           /* 인트라종가 */
                ,   td_etp_basic.F16002                                     AS  etp_nm              /* 한글종목명 */
                
          FROM          kc_etp.td_etp_basic
         INNER  JOIN    td_etp_intra
                  ON    (
                                    td_etp_basic.F16013     =   td_etp_intra.F16013                 /* 단축코드 */

                                    /* 1주 */
                            AND     td_etp_intra.F20044     >=   DATE_FORMAT( DATE_SUB( '20190411', INTERVAL 1 WEEK ), '%Y%m%d' )   /* 인트라체결일자 */
                        )
         WHERE  1 = 1
           AND  td_etp_basic.F16012     =   #{f16012}                       /* 국제표준코드 */

         GROUP  BY      td_etp_intra.F20044
    ]]>
        </if>        


        <if test= 'term == ""  or  term == "1M" or term == "3M" or term == "6M" or term == "1Y" or term == "TOTAL" ' >
    <![CDATA[
        SELECT      td_etp_hist.F12506                                      AS  yyyymmdd            /* 입회일자 */
                ,   DATE_FORMAT( td_etp_hist.F12506, "%Y.%m.%d" )           AS  fmt_yyyymmdd        /* 입회일자 */
                ,   '00'                                                    AS  hh24                /* 생성시각 */
                ,   td_etp_hist.F15001                                      AS  now_price           /* 현재가 */
                ,   td_etp_basic.F16002                                     AS  etp_nm              /* 한글종목명 */
                
          FROM          kc_etp.td_etp_basic
         INNER  JOIN    kc_etp.td_etp_hist
                  ON    (
                                    td_etp_basic.F16013     =   td_etp_hist.F16013          /* 단축코드 */
    ]]>
            <choose>
                <when test="term != null and term =='1M'">
                                    /* 1달 */
                            AND     td_etp_hist.F12506      >=  DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 1 MONTH ), '%Y%m%d' )
                </when>
                <when test="term != null and term =='3M'">
                                    /* 3달 */
                            AND     td_etp_hist.F12506      >=  DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 3 MONTH ), '%Y%m%d' )
                </when>
                <when test="term != null and term =='6M'">
                                    /* 6달 */
                            AND     td_etp_hist.F12506      >=  DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 6 MONTH ), '%Y%m%d' )
                </when>
                <when test="term != null and term =='1Y'">
                                    /* 1년 */
                            AND     td_etp_hist.F12506      >=  DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 1 YEAR ), '%Y%m%d' )
                </when>
                <when test="term != null and term =='TOTAL'">
                                    /* 전체 */
                </when>
                <otherwise>
                                    /* 1달 */
                            AND     td_etp_hist.F12506      >=  DATE_FORMAT( DATE_SUB( NOW(), INTERVAL 1 MONTH ), '%Y%m%d' )
                </otherwise>
            </choose>                            
                        )
         WHERE  1 = 1
           AND  td_etp_basic.F16012     =   #{f16012}                       /* 국제표준코드 */
        </if>

    </select>    

</mapper>