<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="indexModify">

    <!--
    * 지수 마스터 데이터를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuMast">
        SELECT      tm_jisu_mast.jisu_seq                               AS  jisu_seq

                ,   tm_jisu_mast.jisu_id                                AS  jisu_id
                ,   tm_jisu_mast.jisu_kor_nm                            AS  jisu_kor_nm
                ,   tm_jisu_mast.jisu_eng_nm                            AS  jisu_eng_nm
                ,   tm_jisu_mast.jisu_summary                           AS  jisu_summary
                ,   tm_jisu_mast.base_jisu                              AS  base_jisu
                ,   DATE_FORMAT(tm_jisu_mast.base_date,'%Y-%m-%d')      AS  base_date
                ,   tm_jisu_mast.method_file_id                         AS  method_file_id
                ,   tm_jisu_mast.jisu_file_id                           AS  jisu_file_id
                ,   tm_jisu_mast.req_content                            AS  req_content
                ,   tm_jisu_mast.status                                 AS  status
                ,   tm_jisu_mast.reg_id                                 AS  reg_id
                
                ,   tm_code_dtl.com_dtl_name                            AS  status_nm
                ,   tm_code_dtl.com_val01                               AS  status_position

                ,   tm_jisu_mast.jisu_id                                AS  prev_jisu_id
                ,   tm_jisu_mast.method_file_id                         AS  prev_method_file_id
                ,   tm_jisu_mast.jisu_file_id                           AS  prev_jisu_file_id

                ,   jisu_method.org_file_name                           AS  show_method_file

          FROM  tm_jisu_mast
         INNER  JOIN    tm_code_dtl
                  ON    tm_jisu_mast.status         =   tm_code_dtl.com_dtl_cd

          LEFT  OUTER   /* 지수 방법론 파일 */
                 JOIN   tm_jisu_file                jisu_method
                   ON   (
                                tm_jisu_mast.method_file_id     =   jisu_method.file_id
                            AND jisu_method.gubun               =   '001'                   
                            
                        )
         WHERE  1 = 1

           AND  tm_code_dtl.use_yn                  =   '1'
           AND  tm_code_dtl.com_mst_cd              =   'COM001'

           AND  tm_jisu_mast.jisu_seq               =   #{jisu_seq}
    </select>

    <!--
    * 지수정보공개요청 데이터를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuShareReq">
        SELECT      tm_jisu_share_req.inst_cd       AS  inst_cd
                ,   tm_domain_mast.inst_name        AS  inst_name

          FROM  tm_jisu_share_req
         INNER  JOIN    tm_domain_mast
                  ON    (
                                tm_domain_mast.inst_type_name       =   'ETF발행사'
                            AND tm_jisu_share_req.inst_cd           =   tm_domain_mast.inst_cd
                        )

         WHERE  1 = 1

           AND  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
         ORDER  BY  tm_jisu_share_req.inst_cd
    </select>


    <!--
    * 지수 마스터 테이블을 수정한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <insert     id="modifyJisuMast">

        UPDATE      tm_jisu_mast 
           SET      jisu_id             =   #{jisu_id}
                ,   jisu_kor_nm         =   #{jisu_kor_nm}
                ,   jisu_summary        =   #{jisu_summary}
                ,   base_jisu           =   #{base_jisu}
                ,   base_date           =   REPLACE( #{base_date}, '-', '' ) 
                ,   method_file_id      =    ${method_file_id}
                ,   jisu_file_id        =   ${jisu_file_id}
                ,   req_content         =   #{req_content}

        <if test= 'modStatus != null  and  modStatus != "" ' >
                ,   status              =   #{modStatus}
        </if>

                ,   upd_id              =   #{user_id}
                ,   upd_time            =   now() 

         WHERE  jisu_seq                =   #{jisu_seq}

    </insert>


    <!--
    * 삭제할 지수정보공개요청 목록을 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuShareReqForDelete">

        <if test= 'arr_jisu_inst != null  and  arr_jisu_inst.length > 0' >
        WITH    base    AS
        (
            <foreach    collection="arr_jisu_inst"   item="item"    index="index"   separator=" UNION ALL" > 
            SELECT      #{item}  COLLATE utf8_general_ci        AS  inst_cd
            </foreach>
        )

        SELECT      tm_jisu_share_req.jisu_seq                  AS  jisu_seq
                ,   tm_jisu_share_req.inst_cd                   AS  inst_cd
          FROM  tm_jisu_share_req
         WHERE  1 = 1
           AND  tm_jisu_share_req.jisu_seq      =   #{jisu_seq}
           AND  (
                    tm_jisu_share_req.inst_cd
                )
                NOT IN
                (
                    SELECT  base.inst_cd
                      FROM  base
                )
        </if>

        <if test= 'arr_jisu_inst == null  or  arr_jisu_inst.length == 0' >
        SELECT      tm_jisu_share_req.jisu_seq                  AS  jisu_seq
                ,   tm_jisu_share_req.inst_cd                   AS  inst_cd
          FROM  tm_jisu_share_req
         WHERE  1 = 1
           AND  tm_jisu_share_req.jisu_seq      =   #{jisu_seq}
        </if>

    </select>

    <!--
    * 삭제할 지수정보공개요청 목록을 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuShareReqList">
        DELETE
          FROM  tm_jisu_share_req
         WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
        
           AND  tm_jisu_share_req.inst_cd           IN  
                (
        <foreach    collection="jisuShareReqDeleteList"   item="item"    index="index"   separator="," >
                    #{item.inst_cd}
        </foreach>
                )
    </delete>


    <!--
    * 추가할 지수정보공개요청 목록을 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuShareReqForInsert">
        WITH    base    AS
        (
            <foreach    collection="arr_jisu_inst"   item="item"    index="index"   separator=" UNION ALL" > 
            SELECT      #{item}  COLLATE utf8_general_ci        AS  inst_cd
            </foreach>
        )
        SELECT  base.inst_cd                                    AS  inst_cd
          FROM  base
         WHERE  1 = 1
           AND  (
                    base.inst_cd
                )
                NOT IN
                (
                    SELECT  tm_jisu_share_req.inst_cd
                      FROM  tm_jisu_share_req
                     WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
                )
    </select>

    <!--
    * 추가할 지수정보공개요청 목록을 저장한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <insert id="insertJisuShareReqList">
        INSERT  INTO    tm_jisu_share_req
        ( 
                jisu_seq
            ,   inst_cd

            ,   jisu_id
            ,   req_flag
            ,   reg_id 
            ,   reg_time
            ,   upd_id
            ,   upd_time
        ) 
        VALUES 
        <foreach    collection="jisuShareReqInsertList"   item="item"    index="index"   separator="," >
        ( 
                #{jisu_seq}
            ,   #{item.inst_cd}

            ,   #{jisu_id}
            ,   #{req_flag}
            ,   #{user_id}
            ,   now()
            ,   #{user_id}
            ,   now()
        )
        </foreach>
    </insert>

    <!--
    * 수정할 지수정보공개요청 목록을 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuShareReqForUpdate">
        WITH    base    AS
        (
            <foreach    collection="arr_jisu_inst"   item="item"    index="index"   separator=" UNION ALL" > 
            SELECT      #{item}  COLLATE utf8_general_ci        AS  inst_cd
            </foreach>
        )

        SELECT      tm_jisu_share_req.jisu_seq                  AS  jisu_seq
                ,   tm_jisu_share_req.inst_cd                   AS  inst_cd
          FROM      tm_jisu_share_req
                ,   base
         WHERE  1 = 1
           AND  tm_jisu_share_req.jisu_seq      =   #{jisu_seq}
           AND  tm_jisu_share_req.inst_cd       =   base.inst_cd
    </select>

    <!--
    * 수정할 지수정보공개요청 목록을 저장한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <update id="updateJisuShareReqList">
        UPDATE      tm_jisu_share_req

           SET      jisu_id             =   #{jisu_id}

                ,   upd_id              =   #{user_id}
                ,   upd_time            =   now()

         WHERE  jisu_seq                =   #{jisu_seq}
           AND  inst_cd                 IN
                (
                <foreach    collection="jisuShareReqUpdateList"   item="item"    index="index"   separator="," >
                    #{item.inst_cd}
                </foreach>
                )
    </update>



    <!--
    * [지수 엑셀업로드] 를 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuUpload">
        DELETE
          FROM  tm_jisu_upload
         WHERE  tm_jisu_upload.jisu_seq             =   #{jisu_seq}
    </delete>

    <!--
    * [지수 엑셀업로드] 건수를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuUploadCnt">
        SELECT  COUNT(*)                            AS  cnt
          FROM  tm_jisu_upload
         WHERE  tm_jisu_upload.jisu_seq             =   #{jisu_seq}
    </select>




    <!--
    * [지수정보 공유 요청] 을 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuShareReq">
        DELETE
          FROM  tm_jisu_share_req
         WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
    </select>

    <!--
    * [지수정보 공유 요청] 건수를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuShareReqCnt">
        SELECT  COUNT(*)                            AS  cnt
          FROM  tm_jisu_share_req
         WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
    </select>
    




    <!--
    * [지수 파일정보] 을 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuFile">
        DELETE
          FROM  tm_jisu_file
         WHERE  tm_jisu_file.file_id                =   #{file_id}
    </delete>

    <!--
    * [지수 파일정보] 를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuFile">
        SELECT      tm_jisu_file.org_file_name                      AS  org_file_name
                ,   tm_jisu_file.save_file_name                     AS  save_file_name
                ,   tm_jisu_file.file_size                          AS  file_size
                ,   tm_jisu_file.mime_type                          AS  mime_type
                ,   tm_jisu_file.gubun                              AS  gubun

          FROM  tm_jisu_file

         WHERE  tm_jisu_file.file_id                               =   #{file_id}
    </select>




    <!--
    * [지수 파일정보] 를 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuMast">
        DELETE
          FROM  tm_jisu_mast
         WHERE  tm_jisu_mast.jisu_seq               =   #{jisu_seq}
    </delete>

    <!--
    * [지수 파일정보] 건수를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuMastCnt">
        SELECT  COUNT(*)                            AS  cnt
          FROM  tm_jisu_mast
         WHERE  tm_jisu_mast.jisu_seq               =   #{jisu_seq}
    </select>




    <!--
    * [지수 저장전 업로드] 를 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <delete id="deleteJisuTempUpload">
        DELETE
          FROM  tm_jisu_temp_upload
         WHERE  tm_jisu_temp_upload.file_id         =   #{file_id}
    </delete>

    <!--
    * [지수 저장전 업로드] 건수를 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuTempUploadCnt">
        SELECT  COUNT(*)                            AS  cnt
          FROM  tm_jisu_temp_upload
         WHERE  tm_jisu_temp_upload.file_id         =   #{file_id}
    </select>

</mapper>