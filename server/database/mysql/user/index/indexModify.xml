<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="indexModify">

    <!--
    * 지수 파일정보가 존재하는지 확인한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getExistJisuFile">
        SELECT  COUNT(1)                            AS  cnt
          FROM  tm_jisu_file
         WHERE  tm_jisu_file.file_id                =   #{file_id}
    </select>

    <!--
    * 지수 파일정보가 존재하는지 확인한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuFie">
        SELECT      tm_jisu_file.file_id            AS  file_id
                ,   tm_jisu_file.org_file_name      AS  org_file_name
                ,   tm_jisu_file.save_file_name     AS  save_file_name
                ,   tm_jisu_file.file_size          AS  file_size
                ,   tm_jisu_file.mime_type          AS  mime_type
                ,   tm_jisu_file.gubun              AS  gubun

          FROM  tm_jisu_file
         WHERE  tm_jisu_file.file_id                =   #{file_id}
    </select>

    <!--
    * 지수 마스터가 존재하는지 확인한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getExistJisuMast">
        SELECT  COUNT(1)   AS  cnt
          FROM  tm_jisu_mast
         WHERE  tm_jisu_mast.jisu_seq               =   #{jisu_seq}
    </select>

    <!--
    * 지수 엑셀업로드가 존재하는지 확인한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getExistJisuUpload">
        SELECT  COUNT(1)   AS  cnt
          FROM  tm_jisu_upload
         WHERE  tm_jisu_upload.jisu_seq             =   #{jisu_seq}
    </select>

    <!--
    * 등록할 지수 엑셀업로드 목록을 조회한다. ( 입력할 정보 - 저장된 정보 )
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuUploadForInsert">
        WITH    base    AS
        (
        <foreach    collection="dataLists"   item="data"     separator=" UNION ALL " >
            SELECT
                        #{jisu_seq}         AS  jisu_seq
                    ,   ${data.row_no}      AS  "data.row_no"

                    ,   ${jisu_file_id}     AS  jisu_file_id
                    ,   #{data.col01}       AS  "data.col01"
                    ,   #{data.col02}       AS  "data.col02"
                    ,   #{data.col03}       AS  "data.col03"
                    ,   #{data.col04}       AS  "data.col04"
                    ,   #{data.col05}       AS  "data.col05"
        </foreach>
        )

        SELECT      base.jisu_seq           AS  jisu_seq
                ,   base."data.row_no"      AS  "data.row_no"
                
                ,   base.jisu_file_id       AS  jisu_file_id
                ,   base."data.col01"       AS  "data.col01"
                ,   base."data.col02"       AS  "data.col02"
                ,   base."data.col03"       AS  "data.col03"
                ,   base."data.col04"       AS  "data.col04"
                ,   base."data.col05"       AS  "data.col05"
          FROM  base
         WHERE  (
                        base.jisu_seq
                    ,   base."data.row_no"
                )
                NOT IN
                (
                    SELECT      tm_jisu_upload.jisu_seq
                            ,   tm_jisu_upload.row_no
                      FROM  tm_jisu_upload
                     WHERE  tm_jisu_upload.jisu_seq     =   #{jisu_seq}
                )
    </select>

    <!--
    * 수정할 지수 엑셀업로드 목록을 조회한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuUploadForUpdate">
        WITH    base    AS
        (
        <foreach    collection="dataLists"   item="data"     separator=" UNION ALL " >
            SELECT
                        #{jisu_seq}         AS  jisu_seq
                    ,   ${data.row_no}      AS  "data.row_no"

                    ,   ${jisu_file_id}     AS  jisu_file_id
                    ,   #{data.col01}       AS  "data.col01"
                    ,   #{data.col02}       AS  "data.col02"
                    ,   #{data.col03}       AS  "data.col03"
                    ,   #{data.col04}       AS  "data.col04"
                    ,   #{data.col05}       AS  "data.col05"
        </foreach>
        )

        SELECT      base.jisu_seq           AS  jisu_seq
                ,   base."data.row_no"      AS  "data.row_no"
                
                ,   base.jisu_file_id       AS  jisu_file_id
                ,   base."data.col01"       AS  "data.col01"
                ,   base."data.col02"       AS  "data.col02"
                ,   base."data.col03"       AS  "data.col03"
                ,   base."data.col04"       AS  "data.col04"
                ,   base."data.col05"       AS  "data.col05"
          FROM  tm_jisu_upload
         WHERE  (
                        tm_jisu_upload.jisu_seq
                    ,   tm_jisu_upload.row_no
                )
                IN
                (
                    SELECT      base.jisu_seq
                            ,   base."data.row_no"
                      FROM  base
                )
    </select>

    <!--
    * 삭제할 지수 엑셀업로드 목록을 조회한다. ( 저장된 정보 - 입력할 정보 )
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getJisuUploadForDelete">
        WITH    base    AS
        (
        <foreach    collection="dataLists"   item="data"     separator=" UNION ALL " >
            SELECT
                        #{jisu_seq}         AS  jisu_seq
                    ,   ${data.row_no}      AS  "data.row_no"

                    ,   ${jisu_file_id}     AS  jisu_file_id
                    ,   #{data.col01}       AS  "data.col01"
                    ,   #{data.col02}       AS  "data.col02"
                    ,   #{data.col03}       AS  "data.col03"
                    ,   #{data.col04}       AS  "data.col04"
                    ,   #{data.col05}       AS  "data.col05"
        </foreach>
        )

        SELECT      base.jisu_seq           AS  jisu_seq
                ,   base."data.row_no"      AS  "data.row_no"
                
                ,   base.jisu_file_id       AS  jisu_file_id
                ,   base."data.col01"       AS  "data.col01"
                ,   base."data.col02"       AS  "data.col02"
                ,   base."data.col03"       AS  "data.col03"
                ,   base."data.col04"       AS  "data.col04"
                ,   base."data.col05"       AS  "data.col05"
          FROM  tm_jisu_upload
         WHERE  (
                        tm_jisu_upload.jisu_seq
                    ,   tm_jisu_upload.row_no
                )
                NOT IN
                (
                    SELECT      base.jisu_seq
                            ,   base."data.row_no"
                      FROM  base
                )
    </select>    

    <!--
    * 지수 파일 ID 에 해당하는 엑셀업로드 정보를 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="deleteJisuUpload">
        DELETE
          FROM  tm_jisu_upload
         WHERE  tm_jisu_upload.jisu_seq             =   #{jisu_seq}
           AND  tm_jisu_upload.jisu_file_id         =   #{jisu_file_id}
    </select>

    <!--
    * 지수정보 공유 요청 정보가 존재하는지 확인한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="getExistJisuUpload">
        SELECT  COUNT(1)   AS  cnt
          FROM  tm_jisu_share_req
         WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}

        <if test= 'inst_cd != null  and  !inst_cd.equals("")' >	
           AND  tm_jisu_share_req.inst_cd           =   #{inst_cd}
        </if>
    </select>

    <!--
    * 기관코드 삭제목록 대상들을 삭제한다.
    * 2019-04-12  bkLove(촤병국)
    -->
    <select id="deleteJisuShareReq">
        DELETE
          FROM  tm_jisu_share_req
         WHERE  tm_jisu_share_req.jisu_seq          =   #{jisu_seq}
        
           AND  tm_jisu_share_req.inst_cd           IN  
                (
        <foreach    collection="arr_jisu_inst"   item="inst_cd"    index="index"   separator="," >
                    #{inst_cd}
        </foreach>
                )
    </select>    

</mapper>