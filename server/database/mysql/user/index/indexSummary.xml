<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="index">  
    <!--
    * 가장 최근 지수 정보
    -->
    <select id="indexSummaryLately">
      SELECT BAS.F16013
            ,BAS.F16002
            ,BAS.LARGE_TYPE
            ,BAS.MIDDLE_TYPE
            ,HIS.F12506
            ,HIS.F15009
            ,HIS.F15010
            ,HIS.F15011
            ,HIS.F15001
            ,HIS.F15472
            ,HIS.F15006
            ,HIS.F15004
            ,HIS.F15015
            ,HIS.F15023 
        FROM (SELECT * 
                FROM kc_etp.td_index_basic
                WHERE F16013 = (SELECT MAX(F16013)
                                    FROM kc_etp.td_index_basic
                                    WHERE large_type='FNGUIDE'
                                )
                ) BAS,
                kc_etp.td_index_hist HIS
        WHERE BAS.F16013 = HIS.F16013
        ORDER BY HIS.F12506 DESC
        limit 0, 1

    </select>
  
    <!--
    * 지수 정보 공개 요청 리스트
    -->
    <select id="indexReqList">
      SELECT BAS.F16002
            ,BAS.F16013  
            ,REQ.INST_CD
            ,REQ.INST_NAME
            ,date_format(REQ.REG_TIME, '%Y-%m-%d') REG_TIME
            ,REQ.REQ_FLAG
            ,REQ.REG_ID
        FROM td_index_basic BAS, 
            (SELECT A.INST_CD
				   ,A.REG_TIME
                   ,A.REQ_FLAG
                   ,A.REG_ID
                   ,A.JISU_ID
                   ,B.INST_NAME 
          FROM tm_jisu_share_req A,
                    tm_domain_mast B
          WHERE A.INST_CD = B.INST_CD) REQ	
      WHERE BAS.F16013 = REQ.JISU_ID
        AND REQ.REQ_FLAG = '1' OR  REQ.REQ_FLAG = '0'
    </select>

    <!--
    * 지수 정보 공개 요청 처리 
    -->
    <update id="updateIndexOpenYn">
      UPDATE tm_jisu_share_req 
         <set>
             REQ_FLAG = #{FLAG}
             ,UPD_ID = #{UPD_ID}
             ,UPD_TIME = NOW() 
         </set>
       WHERE JISU_ID = #{JISU_ID}
         AND INST_CD = #{INST_CD}
    </update>

    <!-- 지수 목록 정보(로그인 정보엔 맞는 데이터 GET하기, FNGUIDE, WISEFN-->
    <select id="getIndexList">
        <![CDATA[  
        SELECT A.JISU_CD
              ,A.JISU_NM
              ,date_format(A.IP_DT, '%Y-%m-%d') IP_DT
              ,if(A.ANNO_DATE is null, '미발표', '발표') ANNO_YN
              ,A.INDEX_CAL_METHOD
              ,A.MARKET_ID
              ,A.ETP_MARKET_ID
              ,A.INST_CNT
              ,(SELECT GROUP_CONCAT(F16002)
                  FROM td_etp_basic
		         WHERE F34239 = A.ETP_MARKET_ID
	               AND F16257 = A.JISU_CD) as ETP_NM
        FROM (SELECT BAS.F16013 JISU_CD
                    ,BAS.F16002 JISU_NM
                    ,BAS.F12506 IP_DT
                    ,BAS.ANNO_DATE
                    ,BAS.INDEX_CAL_METHOD
                    ,BAS.MARKET_ID
                    ,CAST(substr(BAS.MARKET_ID, 2) AS SIGNED) ETP_MARKET_ID
                    ,(SELECT COUNT(*) FROM kc_etp.tm_jisu_share_req
                        WHERE JISU_ID = BAS.F16013
                        AND REQ_FLAG = '2') INST_CNT
                FROM td_index_basic BAS
               WHERE large_type = 'FNGUIDE') A;
        ]]> 
    </select>


    <!-- 성과가 가장 좋은 지수-->
    <select id="indexSummaryResult">
    <![CDATA[
      WITH  JISU AS
      (SELECT  A.F16013
        FROM (SELECT basic.F16013, 
                    (select max(b.F15009)
                                from (select MIN(F12506) as F12506, F16013 from td_index_hist
                                WHERE F12506 >= date_format(DATE_SUB(now(), INTERVAL 1 YEAR), '%Y%m%d')
                                GROUP BY F16013) a
                                left join td_index_hist b
                                on a.F16013 = b.F16013
                                and a.F12506 = b.F12506
                                where a.F16013 = basic.F16013
                                and b.F15001 is not null
                        ) minData,  
                        (select max(b.F15009)
                                from (select MAX(F12506) as F12506, F16013 from td_index_hist
                                        WHERE F12506 >= date_format(DATE_SUB(now(), INTERVAL 1 YEAR), '%Y%m%d')
                                        GROUP BY F16013) a
                                    left join td_index_hist b
                                        on a.F16013 = b.F16013
                                        and a.F12506 = b.F12506
                                    where a.F16013 = basic.F16013
                                        and b.F15001 is not null
                        ) maxData
                FROM td_index_basic basic
                ) A
            group by F16013
            order by max(ifnull(A.maxData/A.minData, 0)) desc
        limit 0, 1)
        SELECT BAS.F16013
                    ,BAS.F16002
                    ,BAS.LARGE_TYPE
                    ,BAS.MIDDLE_TYPE
                    ,HIS.F12506
                    ,HIS.F15009
                    ,HIS.F15010
                    ,HIS.F15011
                    ,HIS.F15001
                    ,HIS.F15472
                    ,HIS.F15006
                    ,HIS.F15004
                    ,HIS.F15015
                    ,HIS.F15023 
                FROM (SELECT A.F16013
                            ,A.F16002
                            ,A.LARGE_TYPE
                            ,A.MIDDLE_TYPE
                        FROM kc_etp.td_index_basic A,
                            JISU B
                        WHERE A.F16013 = B.F16013
                        ) BAS,
                        kc_etp.td_index_hist HIS
                WHERE BAS.F16013 = HIS.F16013
                ORDER BY HIS.F12506 DESC
                limit 0, 1; 
    ]]>
    </select>
  
    <!-- 1년간 지수 정보(그래프정보)-->
    <select id="selectIndexSummaryHist">
    <![CDATA[
        SELECT F12506 as trd_dd, F15009 as close_idx
          FROM td_index_hist
         WHERE F12506 >= DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 YEAR), '%Y%m%d')
           AND F16013 = #{JISU_ID}
    ]]>
    </select>

    <!-- 인덱스 기본정보-->
    <select id="getIndexBaseInfo">
    <![CDATA[
        SELECT date_format(BAS.F12506, "%Y.%m.%d") F12506
              ,BAS.F16013
              ,BAS.F16002
              ,BAS.F15009
              ,BAS.F15010
              ,BAS.F15011
              ,format(BAS.F15001, '###,###,###') F15001
              ,format(BAS.F15007, '###,###,###') F15007
              ,format(BAS.F15015, '###,###,###') F15015
              ,format(BAS.F15023, '###,###,###') F15023
              ,BAS.F15472
              ,BAS.F15004
              ,BAS.F15006
              ,format(BAS.F15028, '###,###,###') F15028
              ,BAS.LARGE_TYPE
              ,BAS.MIDDLE_TYPE
              ,BAS.MARKET_ID
              ,BAS.STD_INDEX
              ,date_format(BAS.STD_DATE, "%Y.%m.%d") STD_DATE
              ,date_format(BAS.ANNO_DATE, "%Y.%m.%d") ANNO_DATE
              ,BAS.INDEX_CAL_METHOD
              ,BAS.STD_CAPITAL
              ,BAS.FIXED_CASH
              ,BAS.FLOWRATE_YN
        FROM KC_ETP.TD_INDEX_BASIC BAS
        WHERE BAS.F16013 = #{jisu_cd}
          and BAS.MARKET_ID = #{market_id}
    ]]>
    </select>

    <!-- 1년간 지수와 ETP 정보(그래프정보)-->
    <select id="getIndexEtpHistoryData">
    <![CDATA[
        SELECT date_format(B.F12506, "%Y.%m.%d") as trd_dd, B.F15001 as close_idx
          FROM td_index_basic A, 
               td_index_hist B
         WHERE A.F16013 = B.F16013
           AND A.F16013 = #{jisu_cd}
           AND A.MARKET_ID = #{market_id}
           AND B.F12506 >= date_format(DATE_SUB(now(), INTERVAL 2 MONTH), '%Y%m%d')
    ]]>
    </select>


    <!--지수에 속한 ETP 정보-->
    <select id="getIndexInEtpInfo">
      SELECT base.F12506
            ,base.F16012
            ,base.F16013
            ,base.F16002
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961
        FROM kc_etp.td_etp_basic base
        WHERE base.F34239 = CAST(substr(#{market_id}, 2) AS SIGNED) 
        AND base.F16257 = #{jisu_cd}
    </select>
</mapper>