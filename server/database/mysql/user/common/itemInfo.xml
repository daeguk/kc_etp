<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="common.item">  
    <!--
    * 마켓 정보의 구성 기본 정보
    -->
    <select id="getFavorItemInfo">
        SELECT ITEM.ITEM_SEQ 
                ,ITEM.GUBUN
                ,ITEM.ITEM_CD
                ,ITEM.F16002
                ,ITEM.MARKET_ID
                ,ITEM.LARGE_TYPE

                ,ITEM.F16012                                        AS  F16012       /* 국제표준코드 */
                ,ITEM.F16257                                        AS  F16257       /* ETP기초지수코드 */
                ,ITEM.F34239                                        AS  F34239       /* ETP기초지수MID */
            FROM (SELECT A.ITEM_SEQ 
                        ,A.GUBUN
                        ,A.TYPE_CD 
                        ,A.INST_CD
                        ,A.EMAIL
                        ,A.F16012 AS ITEM_CD
                        ,B.F16002
                        ,'' AS MARKET_ID
                        ,A.LARGE_TYPE

                        ,B.F16012                                   AS  F16012       /* 국제표준코드 */
                        ,B.F16257                                   AS  F16257       /* ETP기초지수코드 */
                        ,B.F34239                                   AS  F34239       /* ETP기초지수MID */
                FROM tm_favor_item A
                INNER JOIN td_etp_basic B
                    ON A.F16012 = B.F16012
                AND A.gubun = '1'
                UNION ALL 
                SELECT A.ITEM_SEQ 
                    ,A.GUBUN
                    ,A.TYPE_CD 
                    ,A.INST_CD
                    ,A.EMAIL
                    ,A.F16013 AS ITEM_CD
                    ,B.F16002
                    ,B.MARKET_ID
                    ,A.LARGE_TYPE

                    , ''                                            AS  F16012      /* 국제표준코드 */
                    , B.F16013                                      AS  F16257      /* ETP기초지수코드 */
                    , LPAD( SUBSTR( B.MARKET_ID, 2 ), 3, '0' )      AS  F34239      /* ETP기초지수MID */
                FROM tm_favor_item A
                INNER JOIN td_index_basic B
                ON A.F16013 = B.F16013
                AND A.market_id = B.market_id
                AND A.gubun = '2') ITEM
            WHERE ITEM.TYPE_CD = #{type_cd}
            AND ITEM.INST_CD = #{inst_cd}
            AND ITEM.EMAIL = #{user_id}
        ORDER BY ITEM.ITEM_SEQ 
    </select>
  
    <delete id="deleteFavorItem">
        DELETE FROM tm_favor_item
         WHERE TYPE_CD = #{type_cd}
           AND INST_CD =  #{inst_cd}
           AND EMAIL = #{user_id}
           AND ITEM_SEQ = #{item_seq}
    </delete>



    <insert id="insertFavorItem">
        INSERT INTO tm_favor_item
            (type_cd
            ,inst_cd
            ,email
            ,gubun
            ,F16012
            ,F16013
            ,market_id
            ,large_type
            ,middle_type)
            VALUES
            (
            #{type_cd}
            ,#{inst_cd}
            ,#{user_id}
            ,#{gubun}
            ,#{F16012}
            ,#{F16013}
            ,#{market_id}
            ,#{large_type}
            ,#{middle_type})

    </insert>


    <select id="getTodayIntraInfo">
        SELECT concat(substr(lpad(B.F20004,8, '0'), 1, 2), ':',substr(lpad(B.F20004,8, '0'), 3, 2), ':',substr(lpad(B.F20004,8, '0'), 5, 2)) AS trd_his
               ,DATE_FORMAT(B.F20044, "%Y.%m.%d") as trd_dd
		       ,B.F20008 as close_idx
        FROM td_index_basic A, 
            td_index_intra B
        WHERE A.F16013 = B.F16013
        AND A.MARKET_ID = B.MARKET_ID
        AND A.F16013 = #{f16013}
        AND A.MARKET_ID = #{market_id}
        AND DATE_FORMAT(B.F20044, "%Y.%m.%d") = DATE_FORMAT('20190410', "%Y.%m.%d")
        ORDER BY B.F20044 desc
    </select>

    <!-- 인덱스 기본정보-->
    <select id="getIndexBaseInfo">
    <![CDATA[
        SELECT date_format(BAS.F12506, "%Y.%m.%d") F12506
              ,BAS.F16013
              ,BAS.F16002
              ,BAS.F15009
              ,BAS.F15010
              ,BAS.F15011
              ,CASE    WHEN    DATE_FORMAT(BAS.ANNO_DATE, '%Y%m%d') > DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y%m%d') 
                            THEN    "Y" 
                            ELSE    "N" 
                       END                                                 AS  NEW_YN              /* new 태그 표시여부 */
              ,BAS.F15001
              ,BAS.F15007
              ,BAS.F15015
              ,BAS.F15023
              ,BAS.F15472
              ,BAS.F15004
              ,BAS.F15006
              ,BAS.F15028
              ,BAS.LARGE_TYPE
              ,BAS.MIDDLE_TYPE
              ,BAS.MARKET_ID
              ,BAS.STD_INDEX
              ,date_format(BAS.STD_DATE, "%Y.%m.%d") STD_DATE
              ,date_format(BAS.ANNO_DATE, "%Y.%m.%d") ANNO_DATE
              ,BAS.INDEX_CAL_METHOD
              ,BAS.STD_CAPITAL
              ,BAS.FIXED_CASH
              ,BAS.FLOWRATE_YN


              , ''                                              AS  F16012      /* 국제표준코드 */
              , BAS.F16013                                      AS  F16257      /* ETP기초지수코드 */
              , LPAD( SUBSTR( BAS.MARKET_ID, 2 ), 3, '0' )      AS  F34239      /* ETP기초지수MID */  
                         
        FROM  td_index_basic BAS
        WHERE BAS.large_type = #{large_type}               
    ORDER BY BAS.ANNO_DATE DESC
    ]]>
    </select>
</mapper>