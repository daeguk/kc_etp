<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="common.item">  
    <select id="getIndexMast">
      SELECT large_type, middle_type, market_id, F16013, F16002
      FROM td_index_basic
    </select>

    <select id="getIndexBasic">
      SELECT *
      FROM td_index_basic
      WHERE F16013 = #{F16013}
      AND MARKET_ID = #{market_id}
    </select>

    <select id="getIndexIntra">
      SELECT concat(substr(lpad(F20004,8, '0'), 1, 2), ':',substr(lpad(F20004,8, '0'), 3, 2), ':',substr(lpad(F20004,8, '0'), 5, 2)) AS F20004
              ,DATE_FORMAT(F20044, "%Y.%m.%d") as F20044
          ,F20008
      FROM td_index_intra
      WHERE F16013 = #{F16013}
      AND MARKET_ID = #{market_id}
      ORDER BY F20044 desc, F20004 desc LIMIT 100
    </select>

    <!--
    * INTRA 기간 설정
    -->
    <select id="getIndexIntra1">
        SELECT concat(substr(lpad(F20004,8, '0'), 1, 2), ':',substr(lpad(F20004,8, '0'), 3, 2), ':',substr(lpad(F20004,8, '0'), 5, 2)) AS F20004
               ,DATE_FORMAT(F20044, "%Y.%m.%d") as F20044
		       ,F20008
        FROM td_index_intra
        WHERE F16013 = #{F16013}
        AND market_id = #{market_id}
        ORDER BY F20044 desc, F20004 desc LIMIT ${limit}
    </select>

    <!--
    * HIST 기간 설정
    -->
    <select id="getIndexHist1">
        SELECT DATE_FORMAT(F12506, "%Y.%m.%d") as F12506
		       ,F15001
        FROM td_index_hist
        WHERE F16013 = #{F16013}
        AND market_id = #{market_id}
        ORDER BY F12506 desc LIMIT ${limit}
    </select>

    <select id="getIndexListByType">
        SELECT *
        FROM td_index_basic
        WHERE large_type = #{large_type}
        <if test="middle_type != null and middle_type !=''">
          AND middle_type like CONCAT('%',#{middle_type},'%')
        </if>
        ORDER BY F16013 ASC
    </select>

    <!--
    * INDEX 분석정보
    -->
    <select id="getIndexAnal">
        SELECT *,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Week}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Week,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Month}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Month,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{befYtd}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS befYtd,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef3Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef3Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef5Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef5Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef10Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef10Year
        FROM td_index_basic A
        WHERE A.market_id = #{market_id}
          AND A.F16013 = #{F16013}
    </select>

    <select id="getIndexListAnalByType">
        SELECT *,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Week}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Week,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Month}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Month,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{befYtd}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS befYtd,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef3Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef3Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef5Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef5Year,
          (SELECT B.F15001 FROM td_index_hist B
            WHERE B.market_id = A.market_id
            AND B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef10Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef10Year
        FROM td_index_basic A
        WHERE A.large_type = #{large_type}
        <if test="middle_type != null and middle_type !=''">
          AND A.middle_type like CONCAT('%',#{middle_type},'%')
        </if>
        ORDER BY A.F15023 DESC
    </select>

    <select id="getEtpMast">
        SELECT F16012, F16013, F16002, F16003, F34239, F16257, F16493
        FROM td_etp_basic
    </select>

    <select id="getEtpBasic">
        SELECT *
        FROM td_etp_basic
        WHERE F16013 = #{F16013}
    </select>

    <!--
    * ETP 분석정보
    -->
    <select id="getEtpAnal">
        SELECT *,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Week}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Week,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Month}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Month,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{befYtd}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS befYtd,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Year,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef3Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef3Year,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef5Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef5Year,
          (SELECT B.F15001 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef10Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef10Year
        FROM td_etp_basic A
        WHERE A.F16013 = #{F16013}
    </select>

    <!--
    * ETP 분석정보(NAV)
    -->
    <select id="getEtpNavAnal">
        SELECT *,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Week}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Week,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Month}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Month,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{befYtd}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS befYtd,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef1Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef1Year,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef3Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef3Year,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef5Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef5Year,
          (SELECT B.F15301 FROM td_etp_hist B
            WHERE B.F16013 = A.F16013
<![CDATA[            AND B.F12506 <= #{bef10Year}]]>
            ORDER BY B.F12506 DESC LIMIT 1) AS bef10Year
        FROM td_etp_basic A
        WHERE A.F16013 = #{F16013}
    </select>

    <select id="getEtpIntra">
        SELECT concat(substr(lpad(F20004,8, '0'), 1, 2), ':',substr(lpad(F20004,8, '0'), 3, 2), ':',substr(lpad(F20004,8, '0'), 5, 2)) AS F20004
               ,DATE_FORMAT(F20044, "%Y.%m.%d") as F20044
		       ,F20008
        FROM td_etp_intra
        WHERE F16013 = #{F16013}
        ORDER BY F20044 desc, F20004 desc LIMIT 100
    </select>

    <select id="getEtpMultiIntra">
        SELECT concat(substr(lpad(A.F20004,8, '0'), 1, 2), ':',substr(lpad(A.F20004,8, '0'), 3, 2), ':',substr(lpad(A.F20004,8, '0'), 5, 2)) AS F20004
               ,DATE_FORMAT(B.F20044, "%Y.%m.%d") as F20044
		       ,A.F20008 as F20008, B.F20008 as iF20008
        FROM td_etp_intra A, td_index_intra B
        WHERE A.F16013 = #{F16013}
        AND B.F16013 = #{F16257}
        AND B.market_id = #{market_id}
        AND A.F20044 = B.F20044
        AND A.F20004 = B.F20004
        ORDER BY F20044 desc, F20004 desc LIMIT ${limit}
    </select>

    <!--
      장전에 F15318 이 메모리 값이 0가 됨. 그래서, 당일 데이터 0가 됨.
      장전 기준가 필요한 경우, 아래 getEtpMultiHist1 을 써야함. 조회 속도 느려짐.
    -->
    <select id="getEtpMultiHist">
        SELECT DATE_FORMAT(F12506, "%Y.%m.%d") as F12506
		       ,F15001, F15318 as iF15001
        FROM td_etp_hist
        WHERE F16013 = #{F16013}
        ORDER BY F12506 desc LIMIT ${limit}
    </select>

    <select id="getEtpMultiHist1">
        SELECT DATE_FORMAT(A.F12506, "%Y.%m.%d") as F12506
		       ,A.F15001 as F15001, B.F15001 as iF15001
        FROM td_etp_hist A, td_index_hist B
        WHERE A.F16013 = #{F16013}
        AND B.F16013 = #{F16257}
        AND B.market_id = #{market_id}
        AND A.F12506 = B.F12506
        ORDER BY F12506 desc LIMIT ${limit}
    </select>

    <!--
    * 마켓 정보의 구성 기본 정보
    -->
    <select id="getFavorItemInfo">
        SELECT ITEM.ITEM_SEQ 
                ,ITEM.GUBUN
                ,ITEM.ITEM_CD
                ,ITEM.F16002
                ,ITEM.MARKET_ID
                ,ITEM.LARGE_TYPE

                ,ITEM.F16012                                        AS  F16012       /* 국제표준코드 */
                ,ITEM.F16257                                        AS  F16257       /* ETP기초지수코드 */
                ,ITEM.F34239                                        AS  F34239       /* ETP기초지수MID */
            FROM (SELECT A.ITEM_SEQ 
                        ,A.GUBUN
                        ,A.TYPE_CD 
                        ,A.INST_CD
                        ,A.EMAIL
                        ,A.F16012 AS ITEM_CD
                        ,B.F16002
                        ,'' AS MARKET_ID
                        ,A.LARGE_TYPE

                        ,B.F16012                                   AS  F16012       /* 국제표준코드 */
                        ,B.F16257                                   AS  F16257       /* ETP기초지수코드 */
                        ,B.F34239                                   AS  F34239       /* ETP기초지수MID */

                FROM tm_favor_item A
                INNER JOIN td_etp_basic B
                    ON A.F16012 = B.F16012
                AND A.gubun = '1'
                UNION ALL 
                SELECT A.ITEM_SEQ 
                    ,A.GUBUN
                    ,A.TYPE_CD 
                    ,A.INST_CD
                    ,A.EMAIL
                    ,A.F16013 AS ITEM_CD
                    ,B.F16002
                    ,B.MARKET_ID
                    ,A.LARGE_TYPE

                    , ''                                            AS  F16012      /* 국제표준코드 */
                    , B.F16013                                      AS  F16257      /* ETP기초지수코드 */
                    , LPAD( SUBSTR( B.MARKET_ID, 2 ), 3, '0' )      AS  F34239      /* ETP기초지수MID */

                FROM tm_favor_item A
                INNER JOIN td_index_basic B
                ON A.F16013 = B.F16013
                AND A.market_id = B.market_id
                AND A.gubun = '2') ITEM
            WHERE ITEM.TYPE_CD = #{type_cd}
            AND ITEM.INST_CD = #{inst_cd}
            AND ITEM.EMAIL = #{user_id}
        ORDER BY ITEM.ITEM_SEQ 
    </select>
  
    <delete id="deleteFavorItem">
        DELETE FROM tm_favor_item
         WHERE TYPE_CD = #{type_cd}
           AND INST_CD =  #{inst_cd}
           AND EMAIL = #{user_id}

        <if test="gubun != null and gubun =='1'">
           AND F16012 = #{jisu_cd}
        </if>
        <if test="gubun != null and gubun =='2'">
            AND F16013 = #{jisu_cd}
            AND market_id = #{market_id}
        </if>
        <if test="gubun != null and gubun ==''">
            AND F16012 = '-'
        </if>
    </delete>

    <insert id="insertFavorItem">
        INSERT INTO tm_favor_item
            (type_cd
            ,inst_cd
            ,email
            ,gubun
            ,F16012
            ,F16013
            ,market_id
            ,large_type
            ,middle_type)
            VALUES
            (
            #{type_cd}
            ,#{inst_cd}
            ,#{user_id}
            ,#{gubun}
            ,#{F16012}
            ,#{F16013}
            ,#{market_id}
            ,#{large_type}
            ,#{middle_type})

    </insert>

    <!-- 인덱스 기본정보-->
    <select id="getIndexBaseInfo">
    <![CDATA[
    SELECT BAS.F12506
         ,BAS.F16013
         ,BAS.F16002
         ,BAS.F15009
         ,BAS.F15010
         ,BAS.F15011
         ,BAS.NEW_YN              /* new 태그 표시여부 */
         ,BAS.F15001
         ,BAS.F15007
         ,BAS.F15015
         ,BAS.F15023
         ,BAS.F15472
         ,BAS.F15004
         ,BAS.F15006
         ,BAS.F15028
         ,BAS.LARGE_TYPE
         ,BAS.MIDDLE_TYPE
         ,BAS.MARKET_ID
         ,BAS.STD_INDEX
         ,BAS.STD_DATE
         ,BAS.ANNO_DATE
         ,BAS.INDEX_CAL_METHOD
         ,BAS.STD_CAPITAL
         ,BAS.FIXED_CASH
         ,BAS.FLOWRATE_YN
         ,BAS.F16012      /* 국제표준코드 */
         ,BAS.F16257      /* ETP기초지수코드 */
         ,BAS.F34239      /* ETP기초지수MID */  
         ,BAS.daily /*daily 수익률*/
		 ,TRUNCATE((BAS.F15001 / ifnull(BAS.1week, BAS.F15001)) - 1, 2)  AS 1week
		 ,TRUNCATE((BAS.F15001/ ifnull(BAS.1month, BAS.F15001)) - 1, 2)  AS 1month  
		 ,TRUNCATE((BAS.F15001/ ifnull(BAS.ytd, BAS.F15001)) - 1, 2)  AS ytd 
		 ,TRUNCATE((BAS.F15001/ ifnull(BAS.1year, BAS.F15001)) - 1, 2) AS 1year
		 ,TRUNCATE((BAS.F15001/ ifnull(BAS.3year, BAS.F15001)) -1, 2) AS 3year
    FROM(         
		  SELECT date_format(BAS.F12506, "%Y.%m.%d") F12506
              ,BAS.F16013
              ,BAS.F16002
              ,BAS.F15009
              ,BAS.F15010
              ,BAS.F15011
              ,CASE    WHEN    DATE_FORMAT(BAS.ANNO_DATE, '%Y%m%d') > DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y%m%d') 
                            THEN    "Y" 
                            ELSE    "N" 
                       END                                                 AS  NEW_YN              /* new 태그 표시여부 */
              ,BAS.F15001
              ,BAS.F15007
              ,BAS.F15015
              ,BAS.F15023
              ,BAS.F15472
              ,BAS.F15004
              ,BAS.F15006
              ,BAS.F15028
              ,BAS.LARGE_TYPE
              ,BAS.MIDDLE_TYPE
              ,BAS.MARKET_ID
              ,BAS.STD_INDEX
              ,date_format(BAS.STD_DATE, "%Y.%m.%d") STD_DATE
              ,date_format(BAS.ANNO_DATE, "%Y.%m.%d") ANNO_DATE
              ,BAS.INDEX_CAL_METHOD
              ,BAS.STD_CAPITAL
              ,BAS.FIXED_CASH
              ,BAS.FLOWRATE_YN
              , ''                                              AS  F16012      /* 국제표준코드 */
              , BAS.F16013                                      AS  F16257      /* ETP기초지수코드 */
              , LPAD( SUBSTR( BAS.MARKET_ID, 2 ), 3, '0' )      AS  F34239      /* ETP기초지수MID */                
              , BAS.F15004 as daily /*daily 수익률*/    
				  , @vF12506:= BAS.F12506         
              ,(SELECT F15001
                  FROM (SELECT a.F16013, a.F12506, a.F15009, a.market_id, a.F15001
                             , (CASE @vF16013 WHEN a.F16013 THEN @rownum:=@rownum+1 ELSE @rownum:=1 END) rnum 
                             , (@vF16013:= a.F16013) vF16013
                          FROM td_index_hist a
                         INNER JOIN (SELECT @vF16013:='', @rownum:=0 FROM DUAL) b
                         WHERE a.F12506 >= date_format(DATE_SUB(DATE_FORMAT(@vF12506, '%Y.%m.%d'), INTERVAL 1 week), '%Y%m%d')
                         order BY a.F16013, a.F12506 ASC
								 LIMIT 0, 2) A
                  where A.rnum = 1
                    and A.F16013 = BAS.F16013
						  AND A.market_id = BAS.market_id) AS 1week
				  ,(SELECT F15001
                  FROM (SELECT a.F16013, a.F12506, a.F15009, a.market_id, a.F15001
                             , (CASE @vF16013 WHEN a.F16013 THEN @rownum:=@rownum+1 ELSE @rownum:=1 END) rnum 
                             , (@vF16013:= a.F16013) vF16013
                          FROM td_index_hist a
                         INNER JOIN (SELECT @vF16013:='', @rownum:=0 FROM DUAL) b
                         WHERE a.F12506 >= date_format(DATE_SUB(DATE_FORMAT(@vF12506, '%Y.%m.%d'), INTERVAL 1 MONTH), '%Y%m%d')
                         order BY a.F16013, a.F12506 ASC
								 LIMIT 0, 2) A
                  where A.rnum = 1
                    and A.F16013 = BAS.F16013
						  AND A.market_id = BAS.market_id) AS 1month
				  ,(SELECT F15001
                  FROM (SELECT a.F16013, a.F12506, a.F15009, a.market_id, a.F15001
                             , (CASE @vF16013 WHEN a.F16013 THEN @rownum:=@rownum+1 ELSE @rownum:=1 END) rnum 
                             , (@vF16013:= a.F16013) vF16013
                          FROM td_index_hist a
                         INNER JOIN (SELECT @vF16013:='', @rownum:=0 FROM DUAL) b
                         WHERE DATE_FORMAT(a.F12506, '%Y') = DATE_FORMAT(@vF12506, '%Y')
                         order BY a.F16013, a.F12506 ASC
								 LIMIT 0, 2) A
                  where A.rnum = 1
                    and A.F16013 = BAS.F16013
						  AND A.market_id = BAS.market_id) AS ytd
				  ,(SELECT F15001
                  FROM (SELECT a.F16013, a.F12506, a.F15009, a.market_id, a.F15001
                             , (CASE @vF16013 WHEN a.F16013 THEN @rownum:=@rownum+1 ELSE @rownum:=1 END) rnum 
                             , (@vF16013:= a.F16013) vF16013
                          FROM td_index_hist a
                         INNER JOIN (SELECT @vF16013:='', @rownum:=0 FROM DUAL) b
                         WHERE a.F12506 >= date_format(DATE_SUB(DATE_FORMAT(@vF12506, '%Y.%m.%d'), INTERVAL 1 YEAR), '%Y%m%d')
                         order BY a.F16013, a.F12506 ASC
					    LIMIT 0, 2) A
                  where A.rnum = 1
                    and A.F16013 = BAS.F16013
						  AND A.market_id = BAS.market_id) AS 1year
				  ,(SELECT F15001
                  FROM (SELECT a.F16013, a.F12506, a.F15009, a.market_id, a.F15001
                             , (CASE @vF16013 WHEN a.F16013 THEN @rownum:=@rownum+1 ELSE @rownum:=1 END) rnum 
                             , (@vF16013:= a.F16013) vF16013
                          FROM td_index_hist a
                         INNER JOIN (SELECT @vF16013:='', @rownum:=0 FROM DUAL) b
                         WHERE a.F12506 >= date_format(DATE_SUB(DATE_FORMAT(@vF12506, '%Y.%m.%d'), INTERVAL 3 YEAR), '%Y%m%d')
                         order BY a.F16013, a.F12506 ASC
                         LIMIT 0, 2) A
                  where A.rnum = 1
                    and A.F16013 = BAS.F16013
						  AND A.market_id = BAS.market_id) AS 3year
				 
		   FROM  td_index_basic BAS
        WHERE BAS.large_type = #{large_type}
    ORDER BY BAS.ANNO_DATE DESC
    ) BAS
   
    ]]>
    </select>


      <!--ETF 리스트(관심종목 처리)-->
    <select id="getETFList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013 
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
		WHERE (base.F16493 = '1' OR base.F16493 = '2') 
    </select>

    <!--ETN 리스트(관심종목 처리)-->
    <select id="getETNList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
       where (F16493 = '3' OR F16493 = '4') 
      
    </select>

    <!--전체 etp 리스트(관심종목 처리)-->
    <select id="getAllETPList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
      
    </select>


    <!--발행사가 발행한 ETF 리스트(관심종목 처리)-->
    <select id="getPublishEtfList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013 
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
		WHERE (base.F16493 = '1' OR base.F16493 = '2') 
          AND base.F33960 = #{krx_cd}
    </select>

    <!--발행사별 ETN 리스트(관심종목 처리)-->
    <select id="getPublishEtnList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
       where (F16493 = '3' OR F16493 = '4') 
          AND base.F33960 = #{krx_cd}
    </select>


    <!--발행사별 ETP 리스트(관심종목 처리)-->
    <select id="getPublishAllList">
      SELECT
            if (faver.F16012 = base.F16012, '1', '0') faver 
            ,faver.item_seq faver_seq
            ,base.F12506
            ,base.F16012 as JISU_CD
            ,base.F16012                    /* 국제표준코드 */
            ,base.F16013
            ,base.F16002 as JISU_NM
            ,base.F16003
            ,base.F16017
            ,base.F15001
            ,base.F15472
            ,base.F15004
            ,base.F15006
            ,base.F15009
            ,base.F15010
            ,base.F15011
            ,base.F15015
            ,base.F15023
            ,base.F15028
            ,base.F15029
            ,base.F30812
            ,base.F30813
            ,base.F18438
            ,base.F16143
            ,base.F16073
            ,base.F15007
            ,base.F16493
            ,base.F15301
            ,base.F15302
            ,base.F15303
            ,base.F15304
            ,base.F15305
            ,base.F30818
            ,base.F15318
            ,base.F16497
            ,base.F31892
            ,base.F18450
            ,base.F18001
            ,base.F16500
            ,base.F33307
            ,base.F33308
            ,base.F33951
            ,base.F15319
            ,base.F30823
            ,base.F15602
            ,base.F15631
            ,base.F15632
            ,base.F15633
            ,base.F19288
            ,base.F34515
            ,base.F16499
            ,base.F03329
            ,base.F18439
            ,base.F16109
            ,base.F16257
            ,base.F34777
            ,base.F34521
            ,base.F34776
            ,base.F34514
            ,base.F34239
            ,base.F34241
            ,base.F34769
            ,base.F34770
            ,base.F34771
            ,base.F34772
            ,base.F34775
            ,base.F34778
            ,base.F34779
            ,base.F34780
            ,base.F34781
            ,base.F34782
            ,base.F34783
            ,base.F33960
            ,base.F33961

        FROM kc_etp.td_etp_basic base
        LEFT OUTER JOIN 
           (SELECT * 
		          FROM tm_favor_item faver
		         WHERE faver.gubun = 1  
		           AND type_cd = #{type_cd}
		           AND inst_cd = #{inst_cd}
		           AND email = #{user_id}
            ) faver
          ON base.F16012 = faver.F16012
    </select>

    <!-- 지수 목록 정보(관심종목)-->
    <select id="getIndexList">
        SELECT faver
              ,faver_seq 
              ,A.JISU_CD
              ,A.JISU_NM
              ,A.INDEX_CAL_METHOD
              ,A.MARKET_ID
              ,A.ETP_MARKET_ID
              ,A.LARGE_TYPE
			  ,A.MIDDLE_TYPE
              ,A.F16013 /* 단축코드 */
              ,A.F15001 /* 현재가 */
              ,A.F15007 /* 기준가 */
              ,A.F15472 /* 대비 */
              ,A.F15004 /* 등락률 */
              ,A.F15028 /* 시가총액 */
              ,A.F16012                                                 AS  F16012      /* 국제표준코드 */
              ,A.F16257                                                 AS  F16257      /* ETP기초지수코드 */
              ,A.F34239                                                 AS  F34239      /* ETP기초지수MID */                   
        FROM (SELECT
                    if (faver.F16013 = BAS.F16013 AND BAS.market_id = faver.market_id, '1', '0') faver 
                    ,faver.item_seq faver_seq
                    ,BAS.F16013 JISU_CD
                    ,BAS.F16002 JISU_NM
                    ,BAS.F12506 IP_DT
                    ,BAS.ANNO_DATE
                    ,BAS.INDEX_CAL_METHOD
                    ,BAS.MARKET_ID
                    ,BAS.LARGE_TYPE
                    ,BAS.MIDDLE_TYPE
                    ,BAS.F16013 /* 단축코드 */
                    ,BAS.F15001 /* 현재가 */
                    ,BAS.F15007 /* 기준가 */
                    ,BAS.F15472 /* 대비 */
                    ,BAS.F15004 /* 등락률 */
                    ,BAS.F15028 /* 시가총액 */
                    ,CAST(substr(BAS.MARKET_ID, 2) AS SIGNED) ETP_MARKET_ID
                    ,''                                               AS  F16012        /* 국제표준코드 */
                    , BAS.F16013                                      AS  F16257        /* ETP기초지수코드 */
                    , LPAD( SUBSTR( BAS.MARKET_ID, 2 ), 3, '0' )      AS  F34239        /* ETP기초지수MID */
                FROM td_index_basic BAS
                LEFT OUTER JOIN 
                    (SELECT * 
                            FROM tm_favor_item 
                            WHERE gubun = 2  
                            AND type_cd = #{type_cd}
                            AND inst_cd = #{inst_cd}
                            AND email = #{user_id}
                    ) faver
                    ON BAS.F16013 = faver.F16013
                   AND BAS.MARKET_ID = faver.MARKET_ID
            <if test="large_type != null and large_type !=''">
               WHERE BAS.large_type = #{large_type}
            </if>
            
            ) A
            ORDER BY A.F15028 desc
    </select>
</mapper>