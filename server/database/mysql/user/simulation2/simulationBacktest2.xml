<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="simulationBacktest2">

    <!--
    *   입력할 값을 기준으로 tm_simul_portfolio 와 비교하여 insert, modify 대상 추출
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getTmSimulPortfolioExistCheck11">

        SELECT      /* simulationBacktest.getTmSimulPortfolioExistCheck11  입력할 값을 기준으로 tm_simul_portfolio 와 비교하여 insert, modify 대상 추출 */
                    CASE    WHEN    tm_simul_portfolio2.scen_cd  IS  NULL
                            THEN    'insert'
                            ELSE    'modify'
                    END                                         AS  dtl_status   /* 상세 상태 */
                ,   base.*

          FROM  (        
                <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                <![CDATA[              
                    SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                            ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                            ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                            ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */

                            ,   #{data.rebalance_date}          AS  rebalance_date  /* 리밸런싱 날짜 */
                            ,   #{data.F16013}                  AS  F16013          /* 구성종목코드 */

                            ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                            ,   #{data.importance}              AS  importance      /* 비중 */
                            ,   0                               AS  jisu_rate       /* 지수적용비율 */
                    FROM  DUAL
                ]]>
                </foreach>
                )       base

          LEFT  OUTER   JOIN    tm_simul_portfolio2
                          ON    (
                                            1 = 1
                            <if test= 'status != null  and  status == "insert" ' >
                                    AND     tm_simul_portfolio2.grp_cd           =   base.grp_cd         /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio2.scen_cd          =   base.scen_cd        /* 시나리오코드 */
                                    AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */
                            </if>

                            <if test= 'status != null  and  status == "modify" ' >
                                    AND     tm_simul_portfolio2.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio2.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                                    AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */
                            </if>

                                    AND     tm_simul_portfolio2.F16013           =   base.F16013         /* 구성종목코드 */
                                    AND     tm_simul_portfolio2.reg_id           =   #{user_id}          /* 등록자 ID */
                                    AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */
                                )
         WHERE  1 = 1

    </select>


    <!--
    *   tm_simul_portfolio 을 기준으로 입력할 값과 비교하여 delete 대상 추출
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getTmSimulPortfolioExistCheck22">

        SELECT      /* simulationBacktest.getTmSimulPortfolioExistCheck22  tm_simul_portfolio 을 기준으로 입력할 값과 비교하여 delete 대상 추출 */
                    CASE    WHEN    base.scen_cd    IS  NULL
                            THEN    'delete'
                    END                                         AS  dtl_status   /* 상세 상태 */
                ,   tm_simul_portfolio2.*

          FROM  tm_simul_portfolio2

          LEFT  OUTER   JOIN    (
                                <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                                <![CDATA[              
                                    SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                            ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                            ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                            ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */

                                            ,   #{data.rebalance_date}          AS  rebalance_date  /* 리밸런싱 날짜 */
                                            ,   #{data.F16013}                  AS  F16013          /* 구성종목코드 */

                                            ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                            ,   #{data.importance}              AS  importance      /* 비중 */
                                            ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                    FROM  DUAL
                                ]]>
                                </foreach>
                                )       base
                          ON    (
                                            1 = 1
                                    AND     tm_simul_portfolio2.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio2.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                                    AND     tm_simul_portfolio2.F16013           =   base.F16013         /* 구성종목코드 */
                                    AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */
                                )
         WHERE  1 = 1
           AND  tm_simul_portfolio2.grp_cd           =   #{prev_grp_cd}          /* 그룹코드(상위코드) */
           AND  tm_simul_portfolio2.scen_cd          =   #{prev_scen_cd}         /* 시나리오코드 */

           AND  tm_simul_portfolio2.reg_id           =   #{user_id}              /* 등록자 ID */

    </select>	


    <!--
    * [tm_simul_portfolio] 테이블에 저장한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <insert     id="saveTmSimulPortfolio2">
    <![CDATA[
        INSERT  INTO    
        /* simulationBacktest.saveTmSimulPortfolio2      [tm_simul_portfolio] 테이블에 저장한다. */
        tm_simul_portfolio2
        ( 
                grp_cd                              /* 그룹코드(상위코드) */
            ,   scen_cd                             /* 시나리오코드 */
            ,   F16013                              /* 구성종목코드 */
            ,   rebalance_date                      /* 리밸런싱 날짜 */

            ,   order_no                            /* 정렬 순번 */
            ,   importance                          /* 비중 */
            ,   jisu_rate                           /* 지수적용비율 */

            ,   reg_id                              /* 등록자 ID */
            ,   reg_time                            /* 등록시간 */
            ,   upd_id                              /* 수정자 ID */
            ,   upd_time                            /* 수정시간 */
        )
    ]]>
        VALUES
        <foreach    collection="arr_portfolio"   item="data"     separator="," >
    <![CDATA[  
        ( 
                #{grp_cd}                           /* 그룹코드(상위코드) */
            ,   #{scen_cd}                          /* 시나리오코드 */
            ,   #{data.F16013}                      /* 구성종목코드 */
            ,   #{data.rebalance_date}              /* 리밸런싱 날짜 */

            ,   #{data.order_no}                    /* 정렬 순번 */
            ,   #{data.importance}                  /* 비중 */
            ,   0                                   /* 지수적용비율 */

            ,   #{user_id}                          /* 등록자 ID */
            ,   now()                               /* 등록시간 */
            ,   #{user_id}                          /* 수정자 ID */
            ,   now()                               /* 수정시간 */
        )
    ]]>
        </foreach>

    </insert>	


    <!--
    * [tm_simul_portfolio] 테이블을 수정한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <update     id="modifyTmSimulPortfolio2">

        UPDATE  /* simulationBacktest.modifyTmSimulPortfolio2      [tm_simul_portfolio] 테이블을 수정한다. */
        
                tm_simul_portfolio2
        
         INNER  JOIN    (
                            <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                            <![CDATA[              
                                SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                        ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                        ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                        ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */

                                        ,   #{data.F16013}                  AS  F16013          /* 구성종목코드 */
                                        ,   #{data.rebalance_date}          AS  rebalance_date  /* 리밸런싱 날짜 */

                                        ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                        ,   #{data.importance}              AS  importance      /* 비중 */
                                        ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                FROM  DUAL
                            ]]>
                            </foreach>
                        )       base
                        
                  ON            1 = 1

                        AND     tm_simul_portfolio2.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                        AND     tm_simul_portfolio2.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                        AND     tm_simul_portfolio2.F16013           =   base.F16013         /* 구성종목코드 */
                        AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */

                        AND     tm_simul_portfolio2.reg_id           =   #{user_id}          /* 등록자 ID */

           SET      tm_simul_portfolio2.grp_cd          =   base.grp_cd             /* 그룹코드(상위코드) */
                ,   tm_simul_portfolio2.scen_cd         =   base.scen_cd            /* 시나리오코드 */

                ,   tm_simul_portfolio2.F16013          =   base.F16013             /* 구성종목코드 */
                ,   tm_simul_portfolio2.rebalance_date  =   base.rebalance_date     /* 리밸런싱 날짜 */
                ,   tm_simul_portfolio2.order_no        =   base.order_no           /* 정렬 순번 */
                ,   tm_simul_portfolio2.importance      =   base.importance         /* 비중 */
                ,   tm_simul_portfolio2.jisu_rate       =   base.jisu_rate          /* 지수적용비율 */

                ,   tm_simul_portfolio2.upd_id          =   #{user_id}              /* 수정자 ID */
                ,   tm_simul_portfolio2.upd_time        =   now()                   /* 수정시간 */

    </update>	


    <!--
    * [tm_simul_portfolio] 테이블을 삭제한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <delete     id="deleteTmSimulPortfolio2">
        DELETE  /* simulationBacktest.deleteTmSimulPortfolio2      [tm_simul_portfolio] 테이블을 삭제한다. */
          FROM  tm_simul_portfolio2
         USING  tm_simul_portfolio2

         INNER  JOIN    (
                            <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                            <![CDATA[              
                                SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                        ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                        ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                        ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */
                                        ,   #{data.F16013}                  AS  F16013          /* 구성종목코드 */
                                        ,   #{data.rebalance_date}          AS  rebalance_date  /* 리밸런싱 날짜 */

                                        ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                        ,   #{data.importance}              AS  importance      /* 비중 */
                                        ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                FROM  DUAL
                            ]]>
                            </foreach>
                        )       base
                  ON            1 = 1

                        AND     tm_simul_portfolio2.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                        AND     tm_simul_portfolio2.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                        AND     tm_simul_portfolio2.F16013           =   base.F16013         /* 구성종목코드 */
                        AND     tm_simul_portfolio2.rebalance_date   =   base.rebalance_date /* 리밸런싱 날짜 */

                        AND     tm_simul_portfolio2.reg_id           =   #{user_id}          /* 등록자 ID */
    </delete>	


    <!--
    *   (백테스트) 시뮬레이션 할 기본정보를 조회한다.
    *   2019-08-14  bkLove(촤병국)
    -->
    <select id="getSimulListByBacktest2">
    <![CDATA[
        SELECT      /* simulationBacktest.getSimulListByBacktest2 (백테스트) 시뮬레이션 할 기본정보를 조회한다. */

                    tm_simul_mast.grp_cd                                AS  grp_cd                      /* 그룹코드(상위코드) */
                ,   tm_simul_mast.scen_cd                               AS  scen_cd                     /* 시나리오 코드 */

                ,   tm_simul_mast.start_year                            AS  start_year                  /* 시작년도 */
                ,   tm_simul_mast.rebalance_cycle_cd                    AS  rebalance_cycle_cd          /* 리밸런싱주기 (COM006) */
                ,   tm_simul_mast.rebalance_date_cd                     AS  rebalance_date_cd           /* 리밸런싱일자 (COM007) */
                ,   tm_simul_mast.init_invest_money                     AS  init_invest_money           /* 초기투자금액 */
                ,   tm_simul_mast.bench_mark_cd                         AS  bench_mark_cd               /* 벤치마크 (COM008) */
                ,   (

                        SELECT  tm_code_dtl.com_val01
                          FROM  tm_code_dtl
                         WHERE  tm_code_dtl.com_mst_cd      =   'COM008'
                           AND  tm_code_dtl.com_dtl_cd      =   tm_simul_mast.bench_mark_cd
                    )                                                   AS  bench_index_cd01            /* 벤치마크 인덱스 코드 ( F16013 ) */
                ,   (

                        SELECT  tm_code_dtl.com_val02
                          FROM  tm_code_dtl
                         WHERE  tm_code_dtl.com_mst_cd      =   'COM008'
                           AND  tm_code_dtl.com_dtl_cd      =   tm_simul_mast.bench_mark_cd
                    )                                                   AS  bench_index_cd02            /* 벤치마크 인덱스 코드 ( large_type ) */
                ,   (

                        SELECT  tm_code_dtl.com_val03
                          FROM  tm_code_dtl
                         WHERE  tm_code_dtl.com_mst_cd      =   'COM008'
                           AND  tm_code_dtl.com_dtl_cd      =   tm_simul_mast.bench_mark_cd
                    )                                                   AS  bench_index_cd03            /* 벤치마크 인덱스 코드( middle_type ) */
                ,   (

                        SELECT  tm_code_dtl.com_dtl_name
                          FROM  tm_code_dtl
                         WHERE  tm_code_dtl.com_mst_cd      =   'COM008'
                           AND  tm_code_dtl.com_dtl_cd      =   tm_simul_mast.bench_mark_cd
                    )                                                   AS  bench_index_nm              /* 벤치마크 인덱스 명 */
                
                ,   tm_simul_mast.importance_method_cd                  AS  importance_method_cd        /* 비중설정방식 (COM009) */
                        
                ,   tm_simul_portfolio2.F16013                          AS  F16013                      /* 구성종목코드 */       
                ,   tm_simul_portfolio2.importance                      AS  importance                  /* 비중 */
                ,   tm_simul_portfolio2.jisu_rate                       AS  jisu_rate                   /* 지수적용비율 */
                
                ,   IFNULL(
                            td_kspjong_basic.F16013
                        ,   td_etp_basic.F16013
                    )                                                   AS  F16013                      /* 단축코드 */
                ,   IFNULL(
                            td_kspjong_basic.F16002   
                        ,   td_etp_basic.F16002
                    )                                                   AS  F16002                      /* 한글종목명 */
                ,   IFNULL(
                            td_kspjong_basic.F16017
                        ,   td_etp_basic.F16017
                    )                                                   AS  F16017                      /* 상장일 */
                ,   '0'                                                 AS  IMPORT_YN               /* 시물레이션에 포함 여부*/
          FROM  tm_simul_mast
          JOIN  tm_simul_portfolio2
            ON  (
                            tm_simul_mast.grp_cd        =   tm_simul_portfolio2.grp_cd                   /* 그룹코드(상위코드) */
                    AND     tm_simul_mast.scen_cd       =   tm_simul_portfolio2.scen_cd                  /* 시나리오 코드 */
                    AND     tm_simul_mast.reg_id        =   tm_simul_portfolio2.reg_id                   /* 등록자 ID */
                )

          LEFT  JOIN    td_kspjong_basic
                  ON    (   tm_simul_portfolio2.F16013   =   td_kspjong_basic.F16013 )

          LEFT  JOIN    td_etp_basic
                  ON    (   tm_simul_portfolio2.F16013   =   td_etp_basic.F16013 )                  
        
         WHERE  1 = 1
           AND  tm_simul_mast.grp_cd        =   #{grp_cd}
           AND  tm_simul_mast.scen_cd       =   #{scen_cd}
           
         ORDER  BY  td_kspjong_basic.F16013    
    ]]>
    </select>	


    <!--
    *   start_year 기준 이전 첫 영업일 부터 이력 데이터를 조회한다.
    *   2019-08-14  bkLove(촤병국)
    -->
    <select id="getSimulHistListByScenCd3">

        SELECT      /* simulationBacktest.getSimulHistListByScenCd3  start_year 기준 이전 첫 영업일 부터 이력 데이터를 조회한다. */

                    td_kspjong_hist.F16013                              AS  F16013                  /* 단축코드 */
                ,   td_kspjong_hist.F12506                              AS  F12506                  /* 입회일자 */

                ,   td_kspjong_hist.F30700                              AS  F30700                  /* 가중 수정 현재가 ( 당일 종가 ) - 종가 */
                ,   td_kspjong_hist.F15007                              AS  F15007                  /* 기준가 ( 전일 종가 ) - 기준가 */
                ,   td_kspjong_hist.F16143                              AS  F16143                  /* 상장주식수*/
                ,   td_kspjong_hist.F15001                              AS  F15001                  /* 현재가 */
                ,   (
                        CASE    WHEN    (
                                            SELECT  tm_date_manage.F12506
                                              FROM  tm_date_manage
                                             WHERE  tm_date_manage.F12506       =   td_kspjong_hist.F12506
                                               AND  tm_date_manage.GUBUN        =   base.GUBUN

                                             LIMIT  1
                                        )   IS  NULL
                                THEN    '0'
                                ELSE    '1'
                        END
                    )                                                   AS  rebalancing             /* 리밸런싱 여부 */                
          FROM  (
                    SELECT      tm_simul_portfolio2.F16013               AS  F16013                  /* 종목코드 */
                            ,   (
                                    SELECT  tm_code_dtl.com_val02
                                      FROM  tm_code_dtl
                                     WHERE  tm_code_dtl.com_mst_cd      =   'COM012'
                                       AND  tm_code_dtl.com_dtl_cd      =   CONCAT(     tm_simul_mast.rebalance_cycle_cd 
                                                                                    ,   IFNULL( tm_simul_mast.rebalance_date_cd, '' )
                                                                            )
                                     LIMIT  1
                                )                                       AS  GUBUN                   /* 구분 */

                      FROM  tm_simul_portfolio2
                      JOIN  tm_simul_mast
                        ON  (
                                        tm_simul_portfolio2.grp_cd   =   tm_simul_mast.grp_cd
                                AND     tm_simul_portfolio2.scen_cd  =   tm_simul_mast.scen_cd
                            )
                     WHERE  1 = 1
                       AND  tm_simul_portfolio2.grp_cd   =   #{grp_cd}
                       AND  tm_simul_portfolio2.scen_cd  =   #{scen_cd}
                )     base
          JOIN  td_kspjong_hist
            ON  (   
                <![CDATA[
                            base.F16013                 =   td_kspjong_hist.F16013

                            /* start_year 이전 첫 영업일 이후 부터 시작 */
                    AND     td_kspjong_hist.F12506      >=
                            (
                                SELECT  MAX( td_kspjong_hist.F12506 )
                                  FROM  td_kspjong_hist
                                 WHERE  1 = 1
                                   AND  td_kspjong_hist.F16013      =   '005930' /* 삼성전자 단축키 고정 으로 사용(상장되지 않은 종목일 경우 영업일 NULL)*/
                                   AND  td_kspjong_hist.F12506      <   CONCAT( #{start_year}, '0101' )         /* 입회일자 이전 */
                                   AND  td_kspjong_hist.F12506      >=  DATE_FORMAT( 
                                                                                DATE_SUB( 
                                                                                        CONCAT( #{start_year}, '0101' )
                                                                                    ,   INTERVAL 2 WEEK
                                                                                )
                                                                            ,   '%Y%m%d' 
                                                                        )                                       /* start_year 기준 3 달 전부터 시작  */
                            )
                ]]>
                )        
         ORDER  BY      td_kspjong_hist.F12506          /* 입회일자 */
                    ,   td_kspjong_hist.F16013          /* 단축코드 */

    </select>	

</mapper>