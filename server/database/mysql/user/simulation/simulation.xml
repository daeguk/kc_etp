<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="simulation">

    <!--
    *   상위 그룹정보를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getInitGrpCd">
        SELECT      /* simulation.getInitGrpCd 상위 그룹정보를 조회한다. */

                    tm_simul_mast.scen_cd           AS  grp_cd              /* 시나리오 코드 */
                ,   tm_simul_mast.scen_name         AS  grp_name            /* 시나리오명 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_yn                =   '1'

         ORDER  BY      tm_simul_mast.scen_name
    </select>

    <!--
    *   그룹코드 변경시 하위에 시나리오 건수를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getExistSubCnt">
        SELECT      /* simulation.getExistSubCnt  그룹코드 변경시 하위에 시나리오 건수를 조회한다. */
                    
                    COUNT( tm_simul_mast.scen_cd )  AS  exist_cnt           /* 존재 건수 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_cd                =   #{prev_grp_cd}      /* 그룹코드(상위코드) */
           AND  tm_simul_mast.scen_cd               !=  #{prev_scen_cd}     /* 시나리오 코드 - 변경전 코드는 제외 */
           AND  tm_simul_mast.grp_yn                =   '0'                 /* 그룹여부(1-그룹) */
    </select>

    <!--
    *   next 시나리오명을 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getNextScenName">
        SELECT      /* simulation.getNextScenName next 시나리오명을 조회한다. */

                    CONCAT(
                            #{search_scen_name}
                        ,   '-'
                        ,   IFNULL(
                                    MAX( 
                                        CAST(
                                            REPLACE( 
                                                    SUBSTR(     tm_simul_mast.scen_name
                                                            ,   INSTR( tm_simul_mast.scen_name, #{search_scen_name} ) + LENGTH( #{search_scen_name} ) 
                                                    )
                                                ,   '-'
                                                ,   '' 
                                            )
                                            AS  UNSIGNED INTEGER
                                        )
                                    )
                                ,   0
                            ) + 1
                    )                               AS  next_scen_name

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.scen_name             LIKE    CONCAT( #{search_scen_name}, '%' )        /* 시나리오명 */

                /* 검색문자열 이후 숫자만 추출 */
           AND  REPLACE( 
                                SUBSTR(     tm_simul_mast.scen_name
                                        ,   INSTR( tm_simul_mast.scen_name, #{search_scen_name} ) + LENGTH( #{search_scen_name} ) 
                                )
                            ,   '-'
                            ,   '' 
                )                                   REGEXP  ( '^[0-9]+$' )
    </select>

    <!--
    *   시나리오명이 존재하는지 체크한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getExistScenName">
        SELECT      /* simulation.getExistScenName next 시나리오명이 존재하는지 체크한다. */
                CASE    WHEN    MAX( tm_simul_mast.scen_name )  IS  NULL
                        THEN    'N'
                        ELSE    'Y'
                END                                 AS  exist_yn
          FROM  tm_simul_mast
         WHERE  1 = 1
           AND  tm_simul_mast.scen_name             =   #{scen_name}        /* 시나리오명 */

        <if test= 'status != null  and  status == "modify" ' >
           AND  tm_simul_mast.grp_cd                !=  #{prev_grp_cd}      /* 그룹 코드 */
           AND  tm_simul_mast.scen_cd               !=  #{prev_scen_cd}     /* 시나리오 코드 */
        </if>           
    </select>

    <!--
    *   시뮬레이션 공통코드 초기 데이터를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getInitData">
        SELECT      /* simulation.getInitData 시뮬레이션 공통코드 초기 데이터를 조회한다. */

                    tm_code_dtl.com_mst_cd          AS  com_mst_cd
                ,   tm_code_dtl.com_dtl_cd          AS  com_dtl_cd
                
                ,   tm_code_dtl.com_dtl_name        AS  com_dtl_name
                ,   tm_code_dtl.com_val01           AS  com_val01
                ,   tm_code_dtl.com_val02           AS  com_val02
                ,   tm_code_dtl.com_val03           AS  com_val03

          FROM          tm_code_mast
         INNER  JOIN    tm_code_dtl

                ON      tm_code_mast.com_mst_cd     =   tm_code_dtl.com_mst_cd

         WHERE  tm_code_mast.use_yn                 =   '1'
           AND  tm_code_dtl.use_yn                  =   '1'
           AND  tm_code_mast.com_mst_cd             IN
                (
                    <foreach    collection="arrComMstCd"   item="item"    index="index"   separator=" ," >
                        #{item}
                    </foreach>
                )
         ORDER  BY      tm_code_dtl.com_mst_cd
                    ,   tm_code_dtl.com_dtl_cd    
    </select>


    <!--
    *   시뮬레이션 시나리오 코드를 채번한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getScenCd">
        SELECT      /* simulation.getScenCd 시뮬레이션 시나리오 코드를 채번한다. */
                    LPAD(
                                /* 시나리오 코드 순번값 ( 기존 코드가 존재하지 않는 경우 - 그룹: 0, 비그룹: 100000 부터 시작 ) */
                                IFNULL(
                                        CAST( MAX( tm_simul_mast.scen_cd )  AS  UNSIGNED INTEGER  )
                                    ,   CASE    WHEN    /* 그룹인 경우 정해진 최초값(100000) 부터 시작 */
                                                        #{grp_yn}   =   '1'
                                                THEN    0
                                                ELSE    CAST( #{init_incre_grp_cd}   AS  UNSIGNED INTEGER  )
                                        END
                                )
                            +   /* 증가값 ( 그룹: 100000, 비그룹: 1 씩 증가 ) */
                                CASE    WHEN    /* 그룹인 경우 정해진 최초값(100000) 부터 시작 */
                                                #{grp_yn}   =   '1'
                                        THEN    CAST( #{init_incre_grp_cd}   AS  UNSIGNED INTEGER  )
                                        ELSE    1
                                END
                        ,   10
                        ,   '0' 
                    )                               AS  scen_cd             /* 시나리오 코드 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_yn                =   #{grp_yn}           /* 그룹여부(1-그룹) */

        <if test= 'status != null  and  status == "modify" ' >
            <if test= 'grp_cd != null  and  grp_cd != "" ' >
                /* 수정 상태 일때 변경후 그룹코드 추출 */
           AND  tm_simul_mast.grp_cd                =   #{grp_cd}           /* 그룹 코드 */
            </if>
        </if>
        
    </select>

    <!--
    *   시뮬레이션 시나리오 코드를 채번한다. ( 그룹인 경우 )
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getScenCd1">
        SELECT      /* simulation.getScenCd1 시뮬레이션 시나리오 코드를 채번한다. ( 그룹인 경우 ) */
                    LPAD(
                                /* 시나리오 코드 순번값 ( 기존 코드가 존재하지 않는 경우 - 그룹: 0, 비그룹: 100000 부터 시작 ) */
                                IFNULL(
                                        CAST( MAX( tm_simul_mast.scen_cd )  AS  UNSIGNED INTEGER  )
                                    ,   0
                                )
                            +   /* 증가값 ( 그룹: 100000, 비그룹: 1 씩 증가 ) */
                                CAST( #{init_incre_grp_cd}                  AS  UNSIGNED INTEGER  )
                        ,   10
                        ,   '0' 
                    )                               AS  scen_cd             /* 시나리오 코드 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_yn                =   '1'                /* 그룹여부(1-그룹) */

        <if test= 'status != null  and  status == "modify" ' >
            <if test= 'grp_cd != null  and  grp_cd != "" ' >
                /* 수정 상태 일때 변경후 그룹코드 추출 */
           AND  tm_simul_mast.grp_cd                =   #{grp_cd}           /* 그룹 코드 */
            </if>
        </if>
        
    </select>

    <!--
    *   시뮬레이션 시나리오 코드를 채번한다. ( 그룹이 아닌 경우 )
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getScenCd2">
        SELECT      /* simulation.getScenCd2 시뮬레이션 시나리오 코드를 채번한다. ( 그룹이 아닌 경우 ) */
                    LPAD(
                                /* 시나리오 코드 순번값 ( 기존 코드가 존재하지 않는 경우 - 그룹: 0, 비그룹: 100000 부터 시작 ) */
                                IFNULL(
                                        CAST( MAX( tm_simul_mast.scen_cd )  AS  UNSIGNED INTEGER  )
                                    ,   CAST( #{init_incre_grp_cd}          AS  UNSIGNED INTEGER  )
                                )
                            +   /* 증가값 ( 그룹: 100000, 비그룹: 1 씩 증가 ) */
                                1
                        ,   10
                        ,   '0' 
                    )                               AS  scen_cd             /* 시나리오 코드 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_yn                =   '0'                 /* 그룹여부(1-그룹) */

        <if test= 'status != null  and  status == "modify" ' >
            <if test= 'grp_cd != null  and  grp_cd != "" ' >
                /* 수정 상태 일때 변경후 그룹코드 추출 */
           AND  tm_simul_mast.grp_cd                =   #{grp_cd}           /* 그룹 코드 */
            </if>
        </if>
        
    </select>    

    <!--
    *   시뮬레이션 시나리오 정렬순번을 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getScenOrderNo">
        SELECT      /* simulation.getScenOrderNo 시뮬레이션 시나리오 정렬순번을 조회한다. */
                        IFNULL(
                                CAST( MAX( tm_simul_mast.scen_order_no )  AS  UNSIGNED INTEGER  )
                            ,   0
                        )
                    +   1                           AS  scen_order_no       /* 시나리오 정렬 순번 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_cd                =   #{grp_cd}           /* 그룹코드(상위코드) */
           AND  tm_simul_mast.scen_cd               =   #{scen_cd}          /* 시나리오 코드 */
    </select>    

    <!--
    * [tm_simul_mast] 테이블에 저장한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <insert     id="saveTmSimulMast">
    <![CDATA[
        INSERT  INTO    
        /* simulation.saveTmSimulMast      [tm_simul_mast] 테이블에 저장한다. */
        tm_simul_mast 
        ( 
                grp_cd                              /* 그룹코드(상위코드) */
            ,   scen_cd                             /* 시나리오 코드 */

            ,   scen_depth                          /* 시나리오 DEPTH */
            ,   scen_order_no                       /* 시나리오 정렬 순번 */
            ,   scen_name                           /* 시나리오명 */
            ,   grp_yn                              /* 그룹여부(1-그룹) */
            ,   start_year                          /* 시작년도 */
            ,   rebalance_cycle_cd                  /* 리밸런싱주기 (COM006) */
            ,   rebalance_date_cd                   /* 리밸런싱일자 (COM007) */
            ,   init_invest_money                   /* 초기투자금액 */
            ,   bench_mark_cd                       /* 벤치마크 (COM008) */
            ,   importance_method_cd                /* 비중설정방식 (COM009) */

            ,   reg_id                              /* 등록자 ID */
            ,   reg_time                            /* 등록시간 */
            ,   upd_id                              /* 수정자 ID */
            ,   upd_time                            /* 수정시간 */
        )
        VALUES    
        ( 
                #{grp_cd}                           /* 그룹코드(상위코드) */
            ,   #{scen_cd}                          /* 시나리오 코드 */

            ,   #{scen_depth}                       /* 시나리오 DEPTH */
            ,   #{scen_order_no}                    /* 시나리오 정렬 순번 */
            ,   #{scen_name}                        /* 시나리오명 */
            ,   #{grp_yn}                           /* 그룹여부(1-그룹) */
            ,   #{start_year}                       /* 시작년도 */
            ,   #{rebalance_cycle_cd}               /* 리밸런싱주기 (COM006) */
            ,   #{rebalance_date_cd}                /* 리밸런싱일자 (COM007) */
            ,   #{init_invest_money}                /* 초기투자금액 */
            ,   #{bench_mark_cd}                    /* 벤치마크 (COM008) */
            ,   #{importance_method_cd}             /* 비중설정방식 (COM009) */

            ,   #{user_id}                          /* 등록자 ID */
            ,   now()                               /* 등록시간 */
            ,   #{user_id}                          /* 수정자 ID */
            ,   now()                               /* 수정시간 */
        )
    ]]>
    </insert>

    <!--
    * [tm_simul_mast] 테이블을 수정한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <update     id="modifyTmSimulMast">
    <![CDATA[
        UPDATE      /* simulation.modifyTmSimulMast      [tm_simul_mast] 테이블을 수정한다. */
                    tm_simul_mast

           SET      grp_cd                  =   #{grp_cd}                       /* 그룹코드(상위코드) */
                ,   scen_cd                 =   #{scen_cd}                      /* 시나리오 코드 */

                ,   scen_depth              =   #{scen_depth}                   /* 시나리오 DEPTH */
                ,   scen_order_no           =   #{scen_order_no}                /* 시나리오 정렬 순번 */
                ,   scen_name               =   #{scen_name}                    /* 시나리오명 */
                ,   grp_yn                  =   #{grp_yn}                       /* 그룹여부(1-그룹) */
                ,   start_year              =   #{start_year}                   /* 시작년도 */
                ,   rebalance_cycle_cd      =   #{rebalance_cycle_cd}           /* 리밸런싱주기 (COM006) */
                ,   rebalance_date_cd       =   #{rebalance_date_cd}            /* 리밸런싱일자 (COM007) */
                ,   init_invest_money       =   #{init_invest_money}            /* 초기투자금액 */
                ,   bench_mark_cd           =   #{bench_mark_cd}                /* 벤치마크 (COM008) */
                ,   importance_method_cd    =   #{importance_method_cd}         /* 비중설정방식 (COM009) */

                ,   upd_id                  =   #{user_id}                      /* 수정자 ID */
                ,   upd_time                =   now()                           /* 수정시간 */                

         WHERE  1 = 1
           AND  grp_cd                      =   #{prev_grp_cd}                  /* 그룹코드(상위코드) - 변경전 */
           AND  scen_cd                     =   #{prev_scen_cd}                 /* 시나리오 코드 - 변경전 */
    ]]>
    </update>

    <!--
    * [tm_simul_mast] 테이블을 삭제한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <delete     id="deleteTmSimulMast">
    <![CDATA[
        DELETE  /* simulation.deleteTmSimulMast      [tm_simul_mast] 테이블을 삭제한다. */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  grp_cd                      =   #{grp_cd}                   /* 그룹코드(상위코드) */
           AND  scen_cd                     =   #{scen_cd}                  /* 시나리오 코드 */
    ]]>
    </delete>

    <!--
    *   입력할 값을 기준으로 tm_simul_portfolio 와 비교하여 insert, modify 대상 추출
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getTmSimulPortfolioExistCheck1">

        SELECT      /* simulation.getTmSimulPortfolioExistCheck1  입력할 값을 기준으로 tm_simul_portfolio 와 비교하여 insert, modify 대상 추출 */
                    CASE    WHEN    tm_simul_portfolio.scen_cd  IS  NULL
                            THEN    'insert'
                            ELSE    'modify'
                    END                                         AS  dtl_status   /* 상세 상태 */
                ,   base.*

          FROM  (        
                <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                <![CDATA[              
                    SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                            ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                            ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                            ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */
                            ,   #{data.F16316}                  AS  F16316          /* 구성종목코드 */

                            ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                            ,   #{data.importance}              AS  importance      /* 비중 */
                            ,   0                               AS  jisu_rate       /* 지수적용비율 */
                    FROM  DUAL
                ]]>
                </foreach>
                )       base

          LEFT  OUTER   JOIN    tm_simul_portfolio
                          ON    (
                                            1 = 1
                            <if test= 'status != null  and  status == "insert" ' >
                                    AND     tm_simul_portfolio.grp_cd           =   base.grp_cd         /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio.scen_cd          =   base.scen_cd        /* 시나리오코드 */
                            </if>

                            <if test= 'status != null  and  status == "modify" ' >
                                    AND     tm_simul_portfolio.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                            </if>
                                    AND     tm_simul_portfolio.F16316           =   base.F16316         /* 구성종목코드 */
                                )
         WHERE  1 = 1

    </select>

    <!--
    *   tm_simul_portfolio 을 기준으로 입력할 값과 비교하여 delete 대상 추출
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getTmSimulPortfolioExistCheck2">

        SELECT      /* simulation.getTmSimulPortfolioExistCheck2  tm_simul_portfolio 을 기준으로 입력할 값과 비교하여 delete 대상 추출 */
                    CASE    WHEN    base.scen_cd    IS  NULL
                            THEN    'delete'
                    END                                         AS  dtl_status   /* 상세 상태 */
                ,   tm_simul_portfolio.*

          FROM  tm_simul_portfolio

          LEFT  OUTER   JOIN    (
                                <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                                <![CDATA[              
                                    SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                            ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                            ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                            ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */
                                            ,   #{data.F16316}                  AS  F16316          /* 구성종목코드 */

                                            ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                            ,   #{data.importance}              AS  importance      /* 비중 */
                                            ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                    FROM  DUAL
                                ]]>
                                </foreach>
                                )       base
                          ON    (
                                            1 = 1
                                    AND     tm_simul_portfolio.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                                    AND     tm_simul_portfolio.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                                    AND     tm_simul_portfolio.F16316           =   base.F16316         /* 구성종목코드 */
                                )
         WHERE  1 = 1
           AND  tm_simul_portfolio.grp_cd           =   #{prev_grp_cd}          /* 그룹코드(상위코드) */
           AND  tm_simul_portfolio.scen_cd          =   #{prev_scen_cd}         /* 시나리오코드 */

    </select>    

    <!--
    * [tm_simul_portfolio] 테이블에 저장한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <insert     id="saveTmSimulPortfolio">
    <![CDATA[
        INSERT  INTO    
        /* simulation.saveTmSimulPortfolio      [tm_simul_portfolio] 테이블에 저장한다. */
        tm_simul_portfolio 
        ( 
                grp_cd                              /* 그룹코드(상위코드) */
            ,   scen_cd                             /* 시나리오코드 */
            ,   F16316                              /* 구성종목코드 */

            ,   order_no                            /* 정렬 순번 */
            ,   importance                          /* 비중 */
            ,   jisu_rate                           /* 지수적용비율 */

            ,   reg_id                              /* 등록자 ID */
            ,   reg_time                            /* 등록시간 */
            ,   upd_id                              /* 수정자 ID */
            ,   upd_time                            /* 수정시간 */
        )
    ]]>
        VALUES
        <foreach    collection="arr_portfolio"   item="data"     separator="," >
    <![CDATA[  
        ( 
                #{grp_cd}                           /* 그룹코드(상위코드) */
            ,   #{scen_cd}                          /* 시나리오코드 */
            ,   #{data.F16316}                      /* 구성종목코드 */

            ,   #{data.order_no}                    /* 정렬 순번 */
            ,   #{data.importance}                  /* 비중 */
            ,   0                                   /* 지수적용비율 */

            ,   #{user_id}                          /* 등록자 ID */
            ,   now()                               /* 등록시간 */
            ,   #{user_id}                          /* 수정자 ID */
            ,   now()                               /* 수정시간 */
        )
    ]]>
        </foreach>

    </insert>

    <!--
    * [tm_simul_portfolio] 테이블을 수정한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <update     id="modifyTmSimulPortfolio">

        UPDATE  /* simulation.modifyTmSimulPortfolio      [tm_simul_portfolio] 테이블을 수정한다. */
        
                tm_simul_portfolio
        
         INNER  JOIN    (
                            <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                            <![CDATA[              
                                SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                        ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                        ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                        ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */
                                        ,   #{data.F16316}                  AS  F16316          /* 구성종목코드 */

                                        ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                        ,   #{data.importance}              AS  importance      /* 비중 */
                                        ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                FROM  DUAL
                            ]]>
                            </foreach>
                        )       base
                        
                  ON            1 = 1

                        AND     tm_simul_portfolio.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                        AND     tm_simul_portfolio.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                        AND     tm_simul_portfolio.F16316           =   base.F16316         /* 구성종목코드 */

           SET      tm_simul_portfolio.grp_cd       =   base.grp_cd             /* 그룹코드(상위코드) */
                ,   tm_simul_portfolio.scen_cd      =   base.scen_cd            /* 시나리오코드 */

                ,   tm_simul_portfolio.F16316       =   base.F16316             /* 구성종목코드 */
                ,   tm_simul_portfolio.order_no     =   base.order_no           /* 정렬 순번 */
                ,   tm_simul_portfolio.importance   =   base.importance         /* 비중 */
                ,   tm_simul_portfolio.jisu_rate    =   base.jisu_rate          /* 지수적용비율 */

                ,   tm_simul_portfolio.upd_id       =   #{user_id}              /* 수정자 ID */
                ,   tm_simul_portfolio.upd_time     =   now()                   /* 수정시간 */

    </update>

    <!--
    * [tm_simul_portfolio] 테이블을 삭제한다.
    * 2019-07-26  bkLove(촤병국)
    -->
    <delete     id="deleteTmSimulPortfolio">
        DELETE  /* simulation.deleteTmSimulPortfolio      [tm_simul_portfolio] 테이블을 삭제한다. */
          FROM  tm_simul_portfolio
         USING  tm_simul_portfolio

         INNER  JOIN    (
                            <foreach    collection="arr_portfolio"   item="data"     separator=" UNION ALL" >
                            <![CDATA[              
                                SELECT      #{grp_cd}                       AS  grp_cd          /* 그룹코드(상위코드) */
                                        ,   #{scen_cd}                      AS  scen_cd         /* 시나리오코드 */
                                        ,   #{prev_grp_cd}                  AS  prev_grp_cd     /* 그룹코드(상위코드)-변경전 */
                                        ,   #{prev_scen_cd}                 AS  prev_scen_cd    /* 시나리오코드-변경전 */
                                        ,   #{data.F16316}                  AS  F16316          /* 구성종목코드 */

                                        ,   #{data.order_no}                AS  order_no        /* 정렬 순번 */
                                        ,   #{data.importance}              AS  importance      /* 비중 */
                                        ,   0                               AS  jisu_rate       /* 지수적용비율 */
                                FROM  DUAL
                            ]]>
                            </foreach>
                        )       base
                  ON            1 = 1

                        AND     tm_simul_portfolio.grp_cd           =   base.prev_grp_cd    /* 그룹코드(상위코드) */
                        AND     tm_simul_portfolio.scen_cd          =   base.prev_scen_cd   /* 시나리오코드 */
                        AND     tm_simul_portfolio.F16316           =   base.F16316         /* 구성종목코드 */
    </delete>

    <!--
    *   시뮬레이션 목록정보를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getSimulList">
        SELECT      /* simulation.getSimulList 시뮬레이션 목록정보를 조회한다. */

                    tm_simul_mast.grp_cd                                    AS  grp_cd                      /* 그룹코드(상위코드) */
                ,   tm_simul_mast.scen_cd                                   AS  scen_cd                     /* 시나리오 코드 */

                ,   tm_simul_mast.scen_depth                                AS  scen_depth                  /* 시나리오 DEPTH */
                ,   tm_simul_mast.scen_order_no                             AS  scen_order_no               /* 시나리오 정렬 순번 */
                ,   tm_simul_mast.scen_name                                 AS  scen_name                   /* 시나리오명 */
                ,   tm_simul_mast.grp_yn                                    AS  grp_yn                      /* 그룹여부(1-그룹) */
                ,   tm_simul_mast.start_year                                AS  start_year                  /* 시작년도 */
                ,   tm_simul_mast.rebalance_cycle_cd                        AS  rebalance_cycle_cd          /* 리밸런싱주기 (COM006) */
                ,   tm_simul_mast.rebalance_date_cd                         AS  rebalance_date_cd           /* 리밸런싱일자 (COM007) */
                ,   tm_simul_mast.init_invest_money                         AS  init_invest_money           /* 초기투자금액 */
                ,   tm_simul_mast.bench_mark_cd                             AS  bench_mark_cd               /* 벤치마크 (COM008) */
                ,   tm_simul_mast.importance_method_cd                      AS  importance_method_cd        /* 비중설정방식 (COM009) */

                ,   DATE_FORMAT( tm_simul_mast.upd_time, '%Y.%m.%d' )       AS  fmt_upd_time                /* 수정일 */

          FROM  tm_simul_mast

         ORDER  BY      tm_simul_mast.scen_cd
                    ,   tm_simul_mast.scen_order_no
    </select>

    <!--
    *   시뮬레이션 마스터 정보를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getSimulMast">

        SELECT      /* simulation.getSimulList 시뮬레이션 마스터 정보를 조회한다. */

                    tm_simul_mast.grp_cd                                    AS  grp_cd                      /* 그룹코드(상위코드) */
                ,   tm_simul_mast.scen_cd                                   AS  scen_cd                     /* 시나리오 코드 */

                ,   tm_simul_mast.scen_depth                                AS  scen_depth                  /* 시나리오 DEPTH */
                ,   tm_simul_mast.scen_order_no                             AS  scen_order_no               /* 시나리오 정렬 순번 */
                ,   tm_simul_mast.scen_name                                 AS  scen_name                   /* 시나리오명 */
                ,   tm_simul_mast.grp_yn                                    AS  grp_yn                      /* 그룹여부(1-그룹) */
                ,   tm_simul_mast.start_year                                AS  start_year                  /* 시작년도 */
                ,   tm_simul_mast.rebalance_cycle_cd                        AS  rebalance_cycle_cd          /* 리밸런싱주기 (COM006) */
                ,   tm_simul_mast.rebalance_date_cd                         AS  rebalance_date_cd           /* 리밸런싱일자 (COM007) */
                ,   tm_simul_mast.init_invest_money                         AS  init_invest_money           /* 초기투자금액 */
                ,   tm_simul_mast.bench_mark_cd                             AS  bench_mark_cd               /* 벤치마크 (COM008) */
                ,   tm_simul_mast.importance_method_cd                      AS  importance_method_cd        /* 비중설정방식 (COM009) */

          FROM  tm_simul_mast
         WHERE  1 = 1
           AND  tm_simul_mast.grp_cd            =   #{grp_cd}       /* 그룹코드(상위코드) */
           AND  tm_simul_mast.scen_cd           =   #{scen_cd}      /* 시나리오 코드 */

         ORDER  BY      tm_simul_mast.scen_cd
                    ,   tm_simul_mast.scen_order_no
    </select>

    <!--
    *   시뮬레이션 포트폴리오 정보를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getSimulPortfolio">
        SELECT      /* simulation.getSimulPortfolio 시뮬레이션 포트폴리오 정보를 조회한다. */

                    tm_simul_portfolio.grp_cd                               AS  grp_cd                      /* 그룹코드(상위코드) */
                ,   tm_simul_portfolio.scen_cd                              AS  scen_cd                     /* 시나리오코드  */
                ,   tm_simul_portfolio.F16316                               AS  F16316                      /* 구성종목코드  */

                ,   tm_simul_portfolio.order_no                             AS  order_no                    /* 정렬 순번  */
                ,   tm_simul_portfolio.importance                           AS  importance                  /* 비중  */
                ,   tm_simul_portfolio.jisu_rate                            AS  jisu_rate                   /* 지수적용비율  */

                ,   td_kspjong_basic.F16013                                 AS  F16013                      /* 단축코드 */
                ,   td_kspjong_basic.F16002                                 AS  F16002                      /* 한글종목명 */
                ,   td_kspjong_basic.F15028                                 AS  F15028                      /* 시가총액 */
                ,   td_kspjong_basic.F16017                                 AS  F16017                      /* 상장일 */
                ,   td_kspjong_basic.F16109                                 AS  F16109                      /* 유통주식수 */

          FROM  tm_simul_portfolio
          JOIN  td_kspjong_basic
            ON  tm_simul_portfolio.F16316       =   td_kspjong_basic.F16012

         WHERE  1 = 1
           AND  tm_simul_portfolio.grp_cd       =   #{grp_cd}       /* 그룹코드(상위코드) */
           AND  tm_simul_portfolio.scen_cd      =   #{scen_cd}      /* 시나리오 코드 */

         ORDER  BY      tm_simul_portfolio.scen_cd
                    ,   tm_simul_portfolio.order_no
    </select>

</mapper>