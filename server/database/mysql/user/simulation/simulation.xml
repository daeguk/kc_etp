<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="simulation">

    <!--
    *   상위 그룹정보를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getInitGrpCd">
        SELECT      /* simulation.getInitGrpCd 상위 그룹정보를 조회한다. */

                    tm_simul_mast.grp_cd            AS  grp_cd              /* 그룹코드(상위코드) */
                ,   tm_simul_mast.scen_cd           AS  scen_cd             /* 시나리오 코드 */
                ,   tm_simul_mast.scen_name         AS  scen_name           /* 시나리오명 */

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.grp_yn                =   '1'

         ORDER  BY      tm_simul_mast.scen_name
    </select>

    <!--
    *   next 시나리오명을 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getNextScenName">
        SELECT      /* simulation.getNextScenName next 시나리오명을 조회한다. */

                    CONCAT(
                            #{search_scen_name}
                        ,   '-'
                        ,   CAST(
                                IFNULL(
                                        MAX( 
                                            REPLACE( 
                                                    SUBSTR(     tm_simul_mast.scen_name
                                                            ,   INSTR( tm_simul_mast.scen_name, #{search_scen_name} ) + LENGTH( #{search_scen_name} ) 
                                                    )
                                                ,   '-'
                                                ,   '' 
                                            ) 
                                        )
                                    ,   0
                                )   AS  UNSIGNED INTEGER 
                            ) + 1
                    )                               AS  next_scen_name

          FROM  tm_simul_mast

         WHERE  1 = 1
           AND  tm_simul_mast.scen_name             LIKE    CONCAT( #{search_scen_name}, '%' )        /* 시나리오명 */

                /* 검색문자열 이후 숫자만 추출 */
           AND  REPLACE( 
                                SUBSTR(     tm_simul_mast.scen_name
                                        ,   INSTR( tm_simul_mast.scen_name, #{search_scen_name} ) + LENGTH( #{search_scen_name} ) 
                                )
                            ,   '-'
                            ,   '' 
                )                                   REGEXP  ( '^[0-9]+$' )
    </select>    

    <!--
    *   시뮬레이션 공통코드 초기 데이터를 조회한다.
    *   2019-07-26  bkLove(촤병국)
    -->
    <select id="getInitData">
        SELECT      /* simulation.getInitData 시뮬레이션 공통코드 초기 데이터를 조회한다. */

                    tm_code_dtl.com_mst_cd          AS  com_mst_cd
                ,   tm_code_dtl.com_dtl_cd          AS  com_dtl_cd
                
                ,   tm_code_dtl.com_dtl_name        AS  com_dtl_name
                ,   tm_code_dtl.com_val01           AS  com_val01
                ,   tm_code_dtl.com_val02           AS  com_val02
                ,   tm_code_dtl.com_val03           AS  com_val03

          FROM          tm_code_mast
         INNER  JOIN    tm_code_dtl

                ON      tm_code_mast.com_mst_cd     =   tm_code_dtl.com_mst_cd

         WHERE  tm_code_mast.use_yn                 =   '1'
           AND  tm_code_dtl.use_yn                  =   '1'
           AND  tm_code_mast.com_mst_cd             IN
                (
                    <foreach    collection="arrComMstCd"   item="item"    index="index"   separator=" ," >
                        #{item}
                    </foreach>
                )
         ORDER  BY      tm_code_dtl.com_mst_cd
                    ,   tm_code_dtl.com_dtl_cd    
    </select>

</mapper>